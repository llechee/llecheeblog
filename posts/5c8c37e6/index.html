<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>嵌入式基础 | Lzzの博客</title><meta name="keywords" content="C/C++,嵌入式,学习"><meta name="author" content="Leechee"><meta name="copyright" content="Leechee"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="[TOC] 预览:    操作 ``/etc/init.d/rcS`  是6ull开发板的开机脚本文件 echo &quot;7 4 1 7&quot; > /proc/sys/kernel/printk 开启内核打印信息  开发板挂载: mount -t nfs -o nolock,vers=3 192.168.2.125:/home/book/nfs_rootfs /mnt umount">
<meta property="og:type" content="article">
<meta property="og:title" content="嵌入式基础">
<meta property="og:url" content="https://blogs.leechee.top/posts/5c8c37e6/index.html">
<meta property="og:site_name" content="Lzzの博客">
<meta property="og:description" content="[TOC] 预览:    操作 ``/etc/init.d/rcS`  是6ull开发板的开机脚本文件 echo &quot;7 4 1 7&quot; > /proc/sys/kernel/printk 开启内核打印信息  开发板挂载: mount -t nfs -o nolock,vers=3 192.168.2.125:/home/book/nfs_rootfs /mnt umount">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.imgdb.cn/item/63c0cf0fbe43e0d30e6bb230.webp">
<meta property="article:published_time" content="2022-02-01T15:21:13.000Z">
<meta property="article:modified_time" content="2023-04-11T04:26:04.584Z">
<meta property="article:author" content="Leechee">
<meta property="article:tag" content="C/C++">
<meta property="article:tag" content="嵌入式">
<meta property="article:tag" content="学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/63c0cf0fbe43e0d30e6bb230.webp"><link rel="shortcut icon" href="https://pic.imgdb.cn/item/63c5469cbe43e0d30e2eca99.webp"><link rel="canonical" href="https://blogs.leechee.top/posts/5c8c37e6/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//cdn.dusays.com"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"简","msgToSimplifiedChinese":"繁"},
  noticeOutdate: {"limitDay":120,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章所描述的內容可能已经发生变化，请留意"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":100,"languages":{"author":"作者: Leechee","link":"链接: ","source":"来源: Lzzの博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '嵌入式基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-11 12:26:04'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/ariasakablog.css"><link id="css" rel="stylesheet" href="/css/stylessimple.css"><link rel="stylesheet" href="/css/iconfont.css"><style>#article-container h1:before, h2:before, h3:before, h4:before, h5:before, h6:before { -webkit-animation: avatar_turn_around 3s linear infinite; -moz-animation: avatar_turn_around 3s linear infinite; -o-animation: avatar_turn_around 3s linear infinite; -ms-animation: avatar_turn_around 3s linear infinite; animation: avatar_turn_around 3s linear infinite; }</style><style id="settingStyle"></style><style id="yjjs"></style><style id="themeColor"></style><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/node-snackbar@latest/dist/snackbar.min.css"><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id: "JnlSnWLD7XChjrlx",ck: "JnlSnWLD7XChjrlx"})</script><script src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script><script>new LingQue.Monitor().init({id:"JnnW6bt2WtyehVan"});</script><script src="/swReg.js"></script><style id="grays"></style><script src="https://cdn.jsdelivr.net/npm/prefetch-page"></script><script>addEventListener('DOMContentLoaded', function () {prefetch({ threshold: 25, delay: 3000, limit: 10 ,customs: ['search.xml']})});requestIdleCallback(function () {prefetch({ threshold: 25, delay: 3000, limit: 10,customs: ['search.xml']})})</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/5.4.5/css/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper-lyx/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Lzzの博客" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="/css/progress_bar.css"><script src="/"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 文章</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><span> 随便逛逛</span></a></li><li><a class="site-page child" href="/archives/"><span> 总览</span></a></li><li><a class="site-page child" href="/categories/"><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/project/"><span> 项目</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 我的</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 关于</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><span> 关于我</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.imgdb.cn/item/63c0cf0fbe43e0d30e6bb230.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lzzの博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 文章</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><span> 随便逛逛</span></a></li><li><a class="site-page child" href="/archives/"><span> 总览</span></a></li><li><a class="site-page child" href="/categories/"><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/project/"><span> 项目</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 我的</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 关于</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><span> 关于我</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:rmf.scrollToTop()" rel="external nofollow noreferrer">PAGE_NAME</a></center></div><div id="toggleButtons"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></a></div><div id="randoms"><a class="site-page social-icon" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="fa fa-paper-plane"></i></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">嵌入式基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-01T15:21:13.000Z" title="发表于 2022-02-01 23:21:13">2022-02-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-11T04:26:04.584Z" title="更新于 2023-04-11 12:26:04">2023-04-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">17.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>63分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="嵌入式基础"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/5c8c37e6/#post-comment"><span id="twikoo-count"></span></a></span><span class="post-meta-separator">|&nbsp; <span class="post-meta-dianzan"><a class="dianzan" href="javascript:void(0)" rel="external nofollow noreferrer" onclick="dianzan()"><i class="fas fa-thumbs-up"></i></a><span class="post-meta-label"> 点赞:</span><span class="dianzan-count">0</span></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>[TOC]</p>
<p><strong>预览:</strong></p>
<p><img src="https://pic.imgdb.cn/item/627bc37e09475431295ff01a.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/627bc37e09475431295fefd0.jpg" alt=""></p>
<h1 id="操作"><a class="markdownIt-Anchor" href="#操作"></a> 操作</h1>
<p>``/etc/init.d/rcS`  是6ull开发板的开机脚本文件</p>
<p><code>echo "7 4 1 7" &gt; /proc/sys/kernel/printk</code> 开启内核打印信息</p>
<hr>
<p>开发板挂载: <code>mount -t nfs -o nolock,vers=3 192.168.2.125:/home/book/nfs_rootfs /mnt</code><br>
<code>umount /mnt</code> if busy</p>
<p>NAT的话: <code>mount -t nfs -o nolock,vers=3,port=2049,mountport=9999  192.x.x.x:/home/book/nfs_rootfs /mnt</code></p>
<p>mount命令用来挂载各种支持的文件系统协议到某个目录下。</p>
<p>mount成功之后，开发板在/mnt目录下读写文件时，实际上访问的就是Ubuntu中的/home/book/nfs_rootfs目录，所以开发板和Ubuntu之间通过NFS可以很方便地共享文件。</p>
<p>在开发过程中，在Ubuntu中编译好程序后放入/home/book/nfs_rootfs目录，开发板mount nfs后就可以直接使用/mnt下的文件。</p>
<hr>
<h2 id="网络"><a class="markdownIt-Anchor" href="#网络"></a> 网络</h2>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmcli r wifi on</span><br><span class="line">nmcli dev wifi</span><br><span class="line">nmcli dev wifi connect "DRLyyds" password "19407010220" ifname wlan0</span><br></pre></td></tr></tbody></table></figure>
<p><strong>官方</strong></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">移除GUI: mv /etc/init.d/S07hmi /root reboot</span><br><span class="line">重新加载驱动</span><br><span class="line">rmmod 8723bu.ko</span><br><span class="line">modprobe 8723bu</span><br><span class="line">移除其它控制</span><br><span class="line">ps -ef | grep "wpa"</span><br><span class="line">292 root     /usr/sbin/wpa_supplicant -u</span><br><span class="line">kill -9 292</span><br><span class="line">rm /etc/wpa_supplicant.conf</span><br><span class="line">3.执行wifi链接操作</span><br><span class="line">ifconfig wlan0 up</span><br><span class="line">iw dev wlan0 scan |grep SSID</span><br><span class="line">//wpa_passphrase  HUAWEI zihezihe  &gt;&gt; /etc/wpa_supplicant.conf</span><br><span class="line">-/etc/wpa_supplicant.conf</span><br><span class="line">ctrl_interface=/var/run/wpa_supplicant</span><br><span class="line">ctrl_interface_group=0</span><br><span class="line">update_config=1</span><br><span class="line">network={</span><br><span class="line">        ssid="DRLyyds"</span><br><span class="line">        psk="19407010220"</span><br><span class="line">}</span><br><span class="line">-</span><br><span class="line">wpa_supplicant -B -iwlan0 -c /etc/wpa_supplicant.conf</span><br><span class="line">iw wlan0 link</span><br><span class="line">udhcpc -i wlan0</span><br><span class="line">ping -I wlan0 www.baidu.com</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>设置交叉编译工具链:   <code>vim ~/.bashrc</code>    永久生效</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=arm</span><br><span class="line">export CROSS_COMPILE=arm-buildroot-linux-gnueabihf-</span><br><span class="line">export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h2 id="一些命令"><a class="markdownIt-Anchor" href="#一些命令"></a> 一些命令</h2>
<p>udhcpc : 获取ip 用网线的时候用</p>
<p>make之后, 可以使用make menuconfig来查看命令 状况  然后make <code>100ask_imx6ull_pro_ddr512m_systemV_qt5_defconfig</code> <code>make all</code></p>
<p>编译成功后文件输出路径为 <strong>output/images</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">buildroot2020.02.x </span><br><span class="line"></span><br><span class="line">  ├── output</span><br><span class="line"></span><br><span class="line">​    ├── images  </span><br><span class="line"></span><br><span class="line">​      ├── 100ask_imx6ull-14x14.dtb &lt;--设备树文件  </span><br><span class="line"></span><br><span class="line">​      ├── rootfs.ext2         &lt;--ext2格式根文件系统</span><br><span class="line"></span><br><span class="line">​      ├── rootfs.ext4 -&gt; rootfs.ext2   &lt;--ext2格式根文件系统 </span><br><span class="line"></span><br><span class="line">​      ├── rootfs.tar         </span><br><span class="line"></span><br><span class="line">​      ├── rootfs.tar.bz2       &lt;--打包并压缩的根文件系统，用于NFSROOT启动</span><br><span class="line"></span><br><span class="line">​      ├── 100ask-imx6ull-pro-512d-systemv-v1.img     &lt;--完整的系统镜像(可以用来烧写emmc和sd卡)</span><br><span class="line"></span><br><span class="line">​      ├── u-boot-dtb.imx       &lt;--u-boot镜像</span><br><span class="line"></span><br><span class="line">​      └── zImage         &lt;--内核镜像</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>烧写裸机文件: imx是烧写EMMC, img是烧写到sdCard</p>
<p>parsec</p>
<h1 id="入门"><a class="markdownIt-Anchor" href="#入门"></a> 入门</h1>
<p><strong>Linux启动流程</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zhezheup/picture-house/20220401203510.png" alt=""></p>
<p><strong>IMX6ULL启动流程</strong></p>
<p>reset 开发板复位启动 -&gt; rom 板子只读内存 -&gt;加载UBOOT 去加载 第一段bootloader引导程序 -&gt; uboot里有启动参数(环境变量)来启动kernel -&gt; kernel + dtb 设备树 -&gt; 启动Rootfs 跟文件系统 -&gt; app</p>
<p><strong>使用mount挂载</strong></p>
<p><code>mount -t nfs -o nolock,vers=3 192.168.2.125:/home/book/nfs_rootfs /mnt</code></p>
<p><code>mount -t nfs -o intr,nolock,rsize=1024,wsize=1024 192.168.2.125:/home/book/nfs_rootfs /mnt </code></p>
<p>挂载ubuntu的nfs目录到开发板/mnt目录下，挂载成功后使用<code>df -h</code>命令查看所有挂载。</p>
<p><strong>编译内核镜像-设备树</strong></p>
<p>编译内核模块-&gt;nfs挂载-&gt;传输到开发板 reboot即可使用新的 zImage镜像 *.dtb设备树 /lib/modules模块</p>
<p><strong>编译UBOOT</strong></p>
<p>make distclean 删除之前缓存 -&gt; make mx6ull_14x14_evk_defconfig   -&gt; make</p>
<h1 id="linux"><a class="markdownIt-Anchor" href="#linux"></a> Linux</h1>
<p>shell会去环境变量读取 可以通过<code>echo SPATH</code> 查看</p>
<p>ls: <code>-l(long 显示完整信息) -a(显示隐藏文件) -h(列出大小)</code></p>
<p>cp: <code>r：recursive，递归地，即复制所有文件  f：force，强制覆盖  d：如果源文件为链接文件，也只是把它作为链接文件复制过去，而不是复制实际文件</code></p>
<p>rm: <code>r：recursive，递归地，即删除所有文件  f：force，强制删除</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">chgrp：改变文件所属用户组</span><br><span class="line">        -R : 进行递归的持续更改，也连同子目录下的所有文件、目录都更新成为这个用户组之意。常常用在更改            某一目录内所有文件的情况。</span><br><span class="line">chown：改变文件所有者</span><br><span class="line">chmod：改变文件的权限</span><br><span class="line">        r:  4或0</span><br><span class="line">        ② w:  2或0</span><br><span class="line">        ③ x:  1或0</span><br><span class="line">        这3种权限的取值相加后，就是权限的数字表示。</span><br><span class="line">        例如：文件a的权限为“-rwxrwx---”，它的数值表示为：</span><br><span class="line">        ① owner = rwx = 4+2+1 = 7</span><br><span class="line">        ② group = rwx = 4+2+1 = 7</span><br><span class="line">        ③ others = --- = 0+0 +0 = 0</span><br><span class="line">        使用u、g、o三个字母代表user、group、others 3中身份。此外a代表all，即所有身份。</span><br><span class="line">        范例： </span><br><span class="line">        chmod u=rwx,go=rx  .bashrc</span><br><span class="line"></span><br><span class="line">        也可以增加或去除某种权限，“+”表示添加权限，“-”表示去除权限：</span><br><span class="line">        chmod a+w  .bashrc</span><br><span class="line">        chmod a-x  .bashrc</span><br></pre></td></tr></tbody></table></figure>
<p><strong>查找\搜索命令</strong></p>
<p><strong>find</strong>  <code>find 目录名 选项 查找条件</code>   用来查找文件</p>
<p>例: <code>find /home/book/dira/ -name " test1.txt " </code></p>
<p>! - <strong>查找最近几天(几个小时)之内(之前)有变动的文件</strong></p>
<p><code>$ find /home/book -mtime -2    //查找/home目录下两天内有变动的文件。</code></p>
<p><strong>grep</strong>  grep命令的作用是查找文件中符合条件的字符串，其格式如下： <code>grep [选项] [查找模式] [文件名]</code></p>
<p><code>grep -rn "字符串" 文件名 r(recursive)：递归查找 n(number)：显示目标位置的行号</code>  可以加入-w全字匹配。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">可以在grep的结果中再次执行grep搜索，比如搜索包含有ABC的头文件，可执行如下命令：</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep  “ABC”  *  -nR  |  grep “\.h”</span></span><br><span class="line">上述命令把第1个命令“grep  “ABC”  *  -nR”通过管道传给第2个命令。</span><br><span class="line">即第2个命令在第1个命令的结果中搜索。</span><br></pre></td></tr></tbody></table></figure>
<p>vi 学习见 -&gt; 日常技巧</p>
<p><strong>查找命令或应用程序的所在位置</strong></p>
<p><code>which pwd   //定位到/bin/pwd</code>  <code>whereis pwd  //可得到可执行程序的位置和手册页的位置</code></p>
<h2 id="gcc"><a class="markdownIt-Anchor" href="#gcc"></a> GCC</h2>
<p><strong>GCC 编译选项</strong></p>
<table>
<thead>
<tr>
<th>常用选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>-E</td>
<td>预处理，开发过程中想快速确定某个宏可以使用“-E -dM”</td>
</tr>
<tr>
<td>-c</td>
<td>把预处理、编译、汇编都做了，但是不链接</td>
</tr>
<tr>
<td>-o</td>
<td>指定输出文件</td>
</tr>
<tr>
<td>-I</td>
<td>指定头文件目录</td>
</tr>
<tr>
<td>-L</td>
<td>指定链接时库文件目录</td>
</tr>
<tr>
<td>-l</td>
<td>指定链接哪一个库文件</td>
</tr>
</tbody>
</table>
<p>其他有用的选项:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcc -E main.c   // 查看预处理结果，比如头文件是哪个</span><br><span class="line">gcc -E -dM main.c  &gt; 1.txt  // 把所有的宏展开，存在1.txt里</span><br><span class="line">gcc -Wp,-MD,abc.dep -c -o main.o main.c  // 生成依赖文件abc.dep，后面Makefile会用</span><br><span class="line"></span><br><span class="line">echo 'main(){}'| gcc -E -v -  // 它会列出头文件目录、库目录(LIBRARY_PATH)</span><br></pre></td></tr></tbody></table></figure>
<p><strong>制作, 使用动态库 | 静态库</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">动态库:</span><br><span class="line">制作、编译：</span><br><span class="line">gcc -c -o main.o  main.c</span><br><span class="line">gcc -c -o sub.o   sub.c</span><br><span class="line">gcc -shared  -o libsub.so  sub.o  sub2.o  sub3.o(可以使用多个.o生成动态库)</span><br><span class="line">gcc -o test main.o  -lsub  -L /libsub.so/所在目录/</span><br><span class="line"></span><br><span class="line">运行：</span><br><span class="line">① 先把libsub.so放到Ubuntu的/lib目录，然后就可以运行test程序。</span><br><span class="line">② 如果不想把libsub.so放到/lib，也可以放在某个目录比如/a，然后如下执行：</span><br><span class="line">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/a  </span><br><span class="line">./test</span><br><span class="line"></span><br><span class="line">静态库:</span><br><span class="line">gcc -c -o main.o  main.c</span><br><span class="line">gcc -c -o sub.o   sub.c</span><br><span class="line">ar  crs  libsub.a  sub.o  sub2.o  sub3.o(可以使用多个.o生成静态库)</span><br><span class="line">gcc  -o  test  main.o  libsub.a  (如果.a不在当前目录下，需要指定它的绝对或相对路径)</span><br><span class="line">运行：</span><br><span class="line">不需要把静态库libsub.a放到板子上。</span><br><span class="line">注意:执行arm-linux-gnueabihf-gcc -c -o sub.o   sub.c交叉编译需要在最后面加上 -fPIC参数。</span><br></pre></td></tr></tbody></table></figure>
<p><strong>GCC编译过程</strong></p>
<img src="https://pic.imgdb.cn/item/62add7ee09475431293ddb72.jpg" style="zoom:75%;">
<ul>
<li>
<p>（1）预处理</p>
<p>C/C++源文件中，以“#”开头的命令被称为预处理命令，如包含命令“#include”、宏定义命令“#define”、条件编译命令“#if”、“#ifdef”等。预处理就是将要包含(include)的文件插入原文件中、将宏定义展开、根据条件编译命令选择要使用的代码，最后将这些东西输出到一个“.i”文件中等待进一步处理。</p>
</li>
<li>
<p>（2）编译</p>
<p>编译就是把C/C++代码(比如上述的“.i”文件)“翻译”成汇编代码，所用到的工具为cc1(它的名字就是cc1，x86有自己的cc1命令，ARM板也有自己的cc1命令)。</p>
</li>
<li>
<p>（3）汇编</p>
<p>汇编就是将第二步输出的汇编代码翻译成符合一定格式的机器代码，在Linux系统上一般表现为ELF目标文件(OBJ文件)，用到的工具为as。x86有自己的as命令，ARM版也有自己的as命令，也可能是xxxx-as（比如arm-linux-as）。</p>
<p>“反汇编”是指将机器代码转换为汇编代码，这在调试程序时常常用到。</p>
</li>
<li>
<p>（4）链接</p>
<p>链接就是将上步生成的OBJ文件和系统库的OBJ文件、库文件链接起来，最终生成了可以在特定平台运行的可执行文件，用到的工具为ld或collect2。</p>
</li>
</ul>
<p>编译过程常用选项:</p>
<table>
<thead>
<tr>
<th>常用选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>-E</td>
<td>预处理，开发过程中想快速确定某个宏可以使用“-E -dM”</td>
</tr>
<tr>
<td>-c</td>
<td>把预处理、编译、汇编都做了，但是不链接</td>
</tr>
<tr>
<td>-o</td>
<td>指定输出文件</td>
</tr>
<tr>
<td>-I</td>
<td>指定头文件目录</td>
</tr>
<tr>
<td>-L</td>
<td>指定链接时库文件目录</td>
</tr>
<tr>
<td>-l</td>
<td>指定链接哪一个库文件</td>
</tr>
</tbody>
</table>
<p><strong>总体选项</strong></p>
<p>（1）-c</p>
<p>预处理、编译和汇编源文件，但是不作链接，编译器根据源文件生成OBJ文件。缺省情况下，GCC通过用’.o’替换源文件名的后缀’.c’，‘.i’，`.s’等，产生OBJ文件名。可以使用-o选项选择其他名字。GCC忽略-c选项后面任何无法识别的输入文件。</p>
<p>（2）-S</p>
<p>编译后即停止，不进行汇编。对于每个输入的非汇编语言文件，输出结果是汇编语言文件。缺省情况下，GCC通过用`.s’替换源文件名后缀 ‘.c’，'.i’等等，产生汇编文件名。可以使用-o选项选择其他名字。GCC忽略任何不需要汇编的输入文件。</p>
<p>（3）-E</p>
<p>预处理后即停止，不进行编译。预处理后的代码送往标准输出。</p>
<p>（4）-o file</p>
<p>指定输出文件为file。无论是预处理、编译、汇编还是链接，这个选项都可以使用。如果没有使用-o 选项，默认的输出结果是：可执行文件为a.out；修改输入文件的名称是source.suffix，则它的OBJ文件是source.o，汇编文件是 source.s，而预处理后的C源代码送往标准输出。</p>
<p>（5）-v</p>
<p>显示制作GCC工具自身时的配置命令；同时显示编译器驱动程序、预处理器、编译器的版本号。</p>
<h2 id="makefile"><a class="markdownIt-Anchor" href="#makefile"></a> Makefile</h2>
<p>demo:</p>
<figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">hello: hello.c</span></span><br><span class="line">gcc -o hello hello.c</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f  hello</span><br></pre></td></tr></tbody></table></figure>
<p><strong>完善Makefile</strong></p>
<figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">第1个Makefile，简单粗暴，效率低：</span><br><span class="line">test : main.c sub.c sub.h</span><br><span class="line">    gcc -o test main.c sub.c</span><br><span class="line"></span><br><span class="line">第2个Makefile，效率高，相似规则太多太啰嗦，不支持检测头文件：</span><br><span class="line">test : main.o sub.o</span><br><span class="line">    gcc -o test main.o sub.o</span><br><span class="line">main.o : main.c</span><br><span class="line">    gcc -c -o main.o  main.c</span><br><span class="line">sub.o : sub.c</span><br><span class="line">    gcc -c -o sub.o  sub.c	</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm *.o test -f</span><br><span class="line"></span><br><span class="line">第3个Makefile，效率高，精炼，不支持检测头文件：</span><br><span class="line">test : main.o sub.o</span><br><span class="line">    gcc -o test main.o sub.o</span><br><span class="line">%.o : %.c //%是通配符</span><br><span class="line">    gcc -c -o <span class="variable">$@</span>  <span class="variable">$&lt;</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm *.o test -f</span><br><span class="line"></span><br><span class="line">第4个Makefile，效率高，精炼，支持检测头文件(但是需要手工添加头文件规则)：</span><br><span class="line">test : main.o sub.o</span><br><span class="line">    gcc -o test main.o sub.o</span><br><span class="line">%.o : %.c </span><br><span class="line">    gcc -c -o <span class="variable">$@</span>(代表目标文件)  <span class="variable">$&lt;</span>(代表第一个依赖)</span><br><span class="line">sub.o : sub.h</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm *.o test -f</span><br><span class="line"></span><br><span class="line">第5个Makefile，效率高，精炼，支持自动检测头文件：</span><br><span class="line">objs := main.o sub.o</span><br><span class="line">test : <span class="variable">$(objs)</span></span><br><span class="line">    gcc -o test <span class="variable">$^</span>(表示所有的依赖)</span><br><span class="line"><span class="comment"># 需要判断是否存在依赖文件</span></span><br><span class="line"><span class="comment"># .main.o.d .sub.o.d</span></span><br><span class="line">dep_files(依赖文件) := <span class="variable">$(<span class="built_in">foreach</span> f, <span class="variable">$(objs)</span>, .<span class="variable">$(f)</span>.d)</span></span><br><span class="line">dep_files := <span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(dep_files)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把依赖文件包含进来</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(dep_files)</span>,) (如果这个变量不等于空)</span><br><span class="line">  <span class="keyword">include</span> <span class="variable">$(dep_files)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">%.o : %.c</span><br><span class="line">    gcc -Wp,-MD,.<span class="variable">$@</span>.d  -c -o <span class="variable">$@</span>  <span class="variable">$&lt;</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm *.o test -f</span><br><span class="line"><span class="section">distclean:</span></span><br><span class="line">    rm  <span class="variable">$(dep_files)</span> *.o test -f</span><br><span class="line">    </span><br><span class="line">----</span><br><span class="line">CFLAGS(编译参数) = -Werr (把所有警告都当作错误) -I(指定头文件目录) . -Iinclude(默认头文件目录)</span><br></pre></td></tr></tbody></table></figure>
<p>**假想目标 : ** <code>.PHONY</code></p>
<p>**即时变量  延时变量 : ** <code>export</code>  <code>A := xxx 定义时就确定</code>  <code>B = xxx 使用时才确定</code></p>
<p><code>?=  延时变量 只有在第一次定义才起效</code>  <code>+=  是即时还是延时取决于前面的定义</code></p>
<h3 id="函数"><a class="markdownIt-Anchor" href="#函数"></a> 函数</h3>
<figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">目标(target)…: 依赖(prerequiries)…</span></span><br><span class="line">&lt;tab&gt;命令(command)</span><br><span class="line">如果“依赖文件”比“目标文件”更加新，那么执行“命令”来重新生成“目标文件”。</span><br><span class="line">命令被执行的2个条件：依赖文件比目标文件新，或是 目标文件还没生成。</span><br></pre></td></tr></tbody></table></figure>
<p><code>$(foreach var,list,text)</code></p>
<p>对list中的每一个元素，取出来赋给var，然后把var改为text所描述的形式。</p>
<figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">例子：</span><br><span class="line">objs := a.o b.o</span><br><span class="line">dep_files := <span class="variable">$(<span class="built_in">foreach</span> f, <span class="variable">$(objs)</span>, .<span class="variable">$(f)</span>.d)</span> // 最终 dep_files := .a.o.d .b.o.d</span><br></pre></td></tr></tbody></table></figure>
<p><code>$(wildcard pattern)</code></p>
<p>pattern所列出的文件是否存在，把存在的文件都列出来。</p>
<figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例子：</span><br><span class="line">src_files := $( wildcard  *.c)  // 最终 src_files中列出了当前目录下的所有.c文件</span><br></pre></td></tr></tbody></table></figure>
<p><code>$(filter pattern..., text)</code>  <code>$(filter-out pattern..., text)</code></p>
<p>在text中取出符合patten格式的值            (不符合)</p>
<p><code>$(patsubst pattern, replacement, $(var))</code></p>
<p>从列表中取出每一个值, 如果符合pattern, 则替换为replacement</p>
<p><code>gcc -M c.c</code> 打印出依赖</p>
<p><code>gcc -M -MF c.d c.c</code> 把依赖写入文件c.d</p>
<p><code>gcc -c -o c.o c.c -MD -MF c.d</code>  编译c.o, 把依赖写入文件c.d</p>
<h3 id="通用makefile使用"><a class="markdownIt-Anchor" href="#通用makefile使用"></a> 通用Makefile使用</h3>
<p>目录: <code>D:\imx6ull\01_all_series_quickstart\04_嵌入式Linux应用开发基础知识\source\05_general_Makefile\Makefile_and_readme</code></p>
<p>待补充</p>
<h2 id="文件io"><a class="markdownIt-Anchor" href="#文件io"></a> 文件IO</h2>
<img src="https://pic.imgdb.cn/item/62add82909475431293e37f0.jpg" style="zoom: 67%;">
<ul>
<li>
<p>如果要访问真实的文件(SD卡 等等) 需要挂载</p>
<p>可以 <code>cat /proc/mounts</code> 看是否自动挂载</p>
<p>使用<code>mount /dev/sda1 /mnt</code> 来手动挂载到mnt目录下</p>
</li>
<li>
<p>有些文件是虚拟的,Linux内核提供虚拟文件系统,根据虚拟文件系统里面的文件可以查看内核的一些信息<code>/sys</code></p>
</li>
<li>
<p>其他为驱动文件, 通过函数去直接操作硬件</p>
</li>
</ul>
<p>在Linux内核有俩种驱动,字符设备驱动’c’(ls -al 第一个字母)  块设备’b’  主设备号  次设备号  (通过这些来确定到底是哪一个驱动  哪一个硬件)</p>
<p>不是通用的函数：<code>ioctl/mmap</code></p>
<p><strong>俩个复制文件的demo:</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">这个是用 write / read 方式</span><br><span class="line">    </span><br><span class="line"><span class="number">02</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="number">03</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="number">04</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="number">05</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="number">06</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="number">07</span></span><br><span class="line"><span class="number">08</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">09  * ./copy 1.txt 2.txt</span></span><br><span class="line"><span class="comment">10  * argc    = 3</span></span><br><span class="line"><span class="comment">11  * argv[0] = "./copy"</span></span><br><span class="line"><span class="comment">12  * argv[1] = "1.txt"</span></span><br><span class="line"><span class="comment">13  * argv[2] = "2.txt"</span></span><br><span class="line"><span class="comment">14  */</span></span><br><span class="line"><span class="number">15</span> <span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">16 {</span><br><span class="line"><span class="number">17</span>      <span class="type">int</span> fd_old, fd_new;</span><br><span class="line"><span class="number">18</span>      <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"><span class="number">19</span>      <span class="type">int</span> len;</span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="number">21</span>      <span class="comment">/* 1. 判断参数 */</span></span><br><span class="line"><span class="number">22</span>      <span class="keyword">if</span> (argc != <span class="number">3</span>)</span><br><span class="line"><span class="number">23</span>      {</span><br><span class="line"><span class="number">24</span>              <span class="built_in">printf</span>(<span class="string">"Usage: %s &lt;old-file&gt; &lt;new-file&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line"><span class="number">25</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">26</span>      }</span><br><span class="line"><span class="number">27</span></span><br><span class="line"><span class="number">28</span>      <span class="comment">/* 2. 打开老文件 */</span></span><br><span class="line"><span class="number">29</span>      fd_old = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line"><span class="number">30</span>      <span class="keyword">if</span> (fd_old == <span class="number">-1</span>)</span><br><span class="line"><span class="number">31</span>      {</span><br><span class="line"><span class="number">32</span>              <span class="built_in">printf</span>(<span class="string">"can not open file %s\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line"><span class="number">33</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">34</span>      }</span><br><span class="line"><span class="number">35</span></span><br><span class="line"><span class="number">36</span>      <span class="comment">/* 3. 创建新文件 */</span></span><br><span class="line"><span class="number">37</span>      fd_new = open(argv[<span class="number">2</span>], O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH);</span><br><span class="line"><span class="number">38</span>      <span class="keyword">if</span> (fd_new == <span class="number">-1</span>)</span><br><span class="line"><span class="number">39</span>      {</span><br><span class="line"><span class="number">40</span>              <span class="built_in">printf</span>(<span class="string">"can not creat file %s\n"</span>, argv[<span class="number">2</span>]);</span><br><span class="line"><span class="number">41</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">42</span>      }</span><br><span class="line"><span class="number">43</span></span><br><span class="line"><span class="number">44</span>      <span class="comment">/* 4. 循环： 读老文件-写新文件 */</span></span><br><span class="line"><span class="number">45</span>      <span class="keyword">while</span> ((len = read(fd_old, buf, <span class="number">1024</span>)) &gt; <span class="number">0</span>)</span><br><span class="line"><span class="number">46</span>      {</span><br><span class="line"><span class="number">47</span>              <span class="keyword">if</span> (write(fd_new, buf, len) != len)</span><br><span class="line"><span class="number">48</span>              {</span><br><span class="line"><span class="number">49</span>                      <span class="built_in">printf</span>(<span class="string">"can not write %s\n"</span>, argv[<span class="number">2</span>]);</span><br><span class="line"><span class="number">50</span>                      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">51</span>              }</span><br><span class="line"><span class="number">52</span>      }</span><br><span class="line"><span class="number">53</span></span><br><span class="line"><span class="number">54</span>      <span class="comment">/* 5. 关闭文件 */</span></span><br><span class="line"><span class="number">55</span>      close(fd_old);</span><br><span class="line"><span class="number">56</span>      close(fd_new);</span><br><span class="line"><span class="number">57</span></span><br><span class="line"><span class="number">58</span>      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">59</span> }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这个使用 mmap方式</span><br><span class="line"></span><br><span class="line"><span class="number">02</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="number">03</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="number">04</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="number">05</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="number">06</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="number">07</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="number">08</span></span><br><span class="line"><span class="number">09</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">10  * ./copy 1.txt 2.txt</span></span><br><span class="line"><span class="comment">11  * argc    = 3</span></span><br><span class="line"><span class="comment">12  * argv[0] = "./copy"</span></span><br><span class="line"><span class="comment">13  * argv[1] = "1.txt"</span></span><br><span class="line"><span class="comment">14  * argv[2] = "2.txt"</span></span><br><span class="line"><span class="comment">15  */</span></span><br><span class="line"><span class="number">16</span> <span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">17 {</span><br><span class="line"><span class="number">18</span>      <span class="type">int</span> fd_old, fd_new;</span><br><span class="line"><span class="number">19</span>      <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat</span>;</span></span><br><span class="line"><span class="number">20</span>      <span class="type">char</span> *buf;</span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">22</span>      <span class="comment">/* 1. 判断参数 */</span></span><br><span class="line"><span class="number">23</span>      <span class="keyword">if</span> (argc != <span class="number">3</span>)</span><br><span class="line"><span class="number">24</span>      {</span><br><span class="line"><span class="number">25</span>              <span class="built_in">printf</span>(<span class="string">"Usage: %s &lt;old-file&gt; &lt;new-file&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line"><span class="number">26</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">27</span>      }</span><br><span class="line"><span class="number">28</span></span><br><span class="line"><span class="number">29</span>      <span class="comment">/* 2. 打开老文件 */</span></span><br><span class="line"><span class="number">30</span>      fd_old = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line"><span class="number">31</span>      <span class="keyword">if</span> (fd_old == <span class="number">-1</span>)</span><br><span class="line"><span class="number">32</span>      {</span><br><span class="line"><span class="number">33</span>              <span class="built_in">printf</span>(<span class="string">"can not open file %s\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line"><span class="number">34</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">35</span>      }</span><br><span class="line"><span class="number">36</span></span><br><span class="line"><span class="number">37</span>      <span class="comment">/* 3. 确定老文件的大小 */</span></span><br><span class="line"><span class="number">38</span>      <span class="keyword">if</span> (fstat(fd_old, &amp;stat) == <span class="number">-1</span>)</span><br><span class="line"><span class="number">39</span>      {</span><br><span class="line"><span class="number">40</span>              <span class="built_in">printf</span>(<span class="string">"can not get stat of file %s\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line"><span class="number">41</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">42</span>      }</span><br><span class="line"><span class="number">43</span></span><br><span class="line"><span class="number">44</span>      <span class="comment">/* 4. 映射老文件 */</span></span><br><span class="line"><span class="number">45</span>      buf = mmap(<span class="literal">NULL</span>, stat.st_size, PROT_READ, MAP_SHARED, fd_old, <span class="number">0</span>);</span><br><span class="line"><span class="number">46</span>      <span class="keyword">if</span> (buf == MAP_FAILED)</span><br><span class="line"><span class="number">47</span>      {</span><br><span class="line"><span class="number">48</span>              <span class="built_in">printf</span>(<span class="string">"can not mmap file %s\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line"><span class="number">49</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">50</span>      }</span><br><span class="line"><span class="number">51</span></span><br><span class="line"><span class="number">52</span>      <span class="comment">/* 5. 创建新文件 */</span></span><br><span class="line"><span class="number">53</span>      fd_new = open(argv[<span class="number">2</span>], O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH);</span><br><span class="line"><span class="number">54</span>      <span class="keyword">if</span> (fd_new == <span class="number">-1</span>)</span><br><span class="line"><span class="number">55</span>      {</span><br><span class="line"><span class="number">56</span>              <span class="built_in">printf</span>(<span class="string">"can not creat file %s\n"</span>, argv[<span class="number">2</span>]);</span><br><span class="line"><span class="number">57</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">58</span>      }</span><br><span class="line"><span class="number">59</span></span><br><span class="line"><span class="number">60</span>      <span class="comment">/* 6. 写新文件 */</span></span><br><span class="line"><span class="number">61</span>      <span class="keyword">if</span> (write(fd_new, buf, stat.st_size) != stat.st_size)</span><br><span class="line"><span class="number">62</span>      {</span><br><span class="line"><span class="number">63</span>              <span class="built_in">printf</span>(<span class="string">"can not write %s\n"</span>, argv[<span class="number">2</span>]);</span><br><span class="line"><span class="number">64</span>              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="number">65</span>      }</span><br><span class="line"><span class="number">66</span></span><br><span class="line"><span class="number">67</span>      <span class="comment">/* 5. 关闭文件 */</span></span><br><span class="line"><span class="number">68</span>      close(fd_old);</span><br><span class="line"><span class="number">69</span>      close(fd_new);</span><br><span class="line"><span class="number">70</span></span><br><span class="line"><span class="number">71</span>      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">72</span> }</span><br></pre></td></tr></tbody></table></figure>
<h3 id="系统调用函数怎么进入内核"><a class="markdownIt-Anchor" href="#系统调用函数怎么进入内核"></a> 系统调用函数怎么进入内核?</h3>
<p>应用程序通过 open/read/write 进而去访问设备、文件。</p>
<p>进入到内核kernel, 对于普通文件,会使用文件系统去读取对应的磁盘, 对于硬件, 会去找到内核中对应的驱动程序调用相关的程序</p>
<p><strong>调用过程</strong></p>
<p>这些关于文件的函数一般是由<code>glibc</code>提供的,以及其他不同版本的C库(ucibc), open这些要去打开文件需要依赖操作系统提供的功能(怎么进入Linux内核),  可以把内核当作另外一个APP , 这个app不能去调用另外一个app里面的函数</p>
<p>open函数里面会放一条指令, 比如在32为cpu,会使用<code>swi</code>指令, 对于64位cpu, 使用<code>svc</code>指令, 一旦执行这些指令, 就会触发CPU的异常, 会导致CPU跳到某个地址里面去执行系统里面的代码, 这时候操作系统就会去执行对应的<code>sys_open  sys_read</code>函数, 对于read , write 函数也是如此.</p>
<p>那么它怎么知道app触发这个异常是为了去调用<code>sys_open</code>或者是<code>sys_read</code>, glibc在实现sys这些系统调用的时候, 会使用这些命令(swi等)来触发异常, 并且传入不同的参数给内核, 内核根据不同的参数来分辨是想调用哪个</p>
<p><img src="https://pic.imgdb.cn/item/62add89b09475431293edbfd.jpg" alt=""></p>
<ul>
<li>glibc里面怎么传递参数给内核呢?  最开始用的old abi 二进制接口(老的API), 在执行swi指令的时候可以在这条指令后面跟一个数值,  内核执行这个swi的异常处理函数时会把后面的数值取出来, 根据里面的值知道要去调用什么函数.</li>
<li>后来又有改进,使用EABI, 不在swi里面传参数了, 它事先在 R7 寄存器(汇编) 里面存入那些值, 当发生异常的时候,内核会去R7寄存器得到这些值, 进而得到去执行sys的什么函数</li>
<li>对于64位,使用svc指令, 通过X8寄存器传入, 内核里面有一个<code>系统函数调用指针数组</code>, <code>sys_call_table</code>内核把库函数传进来的值处理之后,  用这个值作为下标, 在这个数组里面对应的函数.(阅读glibc的源码,内核源码)</li>
</ul>
<p><strong>app调用openread导致内核的sys_openread被调用,那么内核的sys_openread会做什么事情呢</strong></p>
<img src="https://pic.imgdb.cn/item/62add8b609475431293f0925.jpg" style="zoom:67%;">
<h1 id="linux软件架构"><a class="markdownIt-Anchor" href="#linux软件架构"></a> Linux软件架构</h1>
<p>在linux系统软件<a target="_blank" rel="noopener external nofollow noreferrer" href="https://so.csdn.net/so/search?q=%E6%9E%B6%E6%9E%84&amp;spm=1001.2101.3001.7020">架构</a>可以分为4个层次（从低到高分别为）：</p>
<p><strong>1.引导加载程序</strong></p>
<p>​     引导加载程序（Bootloader）是固化在硬件Flash中的一段引导代码，用于完成硬件的一些基本配置，引导内核启动。</p>
<p>​     同时，Bootloader会在自身与内核分区之间存放一些可设置的参数（Boot parameters），比如IP地址，串口<a target="_blank" rel="noopener external nofollow noreferrer" href="https://so.csdn.net/so/search?q=%E6%B3%A2%E7%89%B9%E7%8E%87&amp;spm=1001.2101.3001.7020">波特率</a>，要传递给内核的命令行参数。</p>
<p><strong>2.系统内核</strong></p>
<p>​     系统内核（Kernel）是整个操作系统的最底层，它负责整个硬件的驱动，以及提供各种系统所需的核心功能，包括防火墙机制、是否支持LVM或Quota等文件系统等等，如果内核不认识某个最新的硬件，那么硬件也就无法被驱动，你也就无法使用该硬件。计算机真正工作的东西其实是硬件，例如数值运算要使用到CPU、数据储存要使用到硬盘、图形显示会用到显示适配器、音乐发声要有音效芯片、连接Internet 可能需要网络卡等等。内核就是控制这些芯片如何工作。</p>
<p><strong>3.文件系统</strong></p>
<p>​     Linux文件系统（File System）中的文件是数据的集合，文件系统不仅包含着文件中的数据而且还有文件系统的结构，所有Linux 用户和程序看到的文件、目录、软连接及文件保护信息等都存储在其中。</p>
<p>​     文件系统是操作系统用于明确存储设备（常见的是磁盘，也有基于NAND Flash的固态硬盘）或分区上的文件的方法和数据结构；即在存储设备上组织文件的方法。操作系统中负责管理和存储文件信息的软件机构称为文件管理系统，简称文件系统。</p>
<p><strong>4.用户程序</strong></p>
<p>​     用户应用程序（Application）为了完成某项或某几项特定任务而被开发运行于操作系统之上的计算机程序。</p>
<h2 id="linux启动过程"><a class="markdownIt-Anchor" href="#linux启动过程"></a> Linux启动过程</h2>
<p>正常启动过程中，Bootloader首先运行，然后将内核复制到内存中（或者在固态存储设备上直接运行，但是效率较低），并在内存某个固定的地址（包括地址与参数的结构）设置好要传递给内核的参数，最后运行内核。内核启动后，挂载（mount）根文件系统（Root filesystem），启动文件系统中的应用程序。</p>
<p>上电 ——&gt; Bootloader —[传递参数]—&gt; 加载内核 ——&gt; 内核挂载根文件系统 ——&gt;执行应用程序</p>
<img src="https://pic.imgdb.cn/item/62ade7f60947543129581ca2.jpg" style="zoom: 50%;">
<h2 id="如何理解bootloader与kernel"><a class="markdownIt-Anchor" href="#如何理解bootloader与kernel"></a> 如何理解Bootloader与Kernel</h2>
<p>操作系统内核本身就是一个裸机程序，和我们学的uboot和其他裸机程序没有本质的区别；事实上，不少U-Boot源码就是根据相应的Linux内核源程序进行简化而形成的，尤其是一些设备的驱动程序。如果我们去琢磨U-Boot源码的注释，便会轻易的发现这一情况。</p>
<p>区别就是操作系统运行起来后可以分为应用层（用户态）和内核层（内核态），分层后，两层的权限不同（实现的原理是基于CPU的模式切换），内存访问和设备操作的管理上更加精细（内核可以随便方位各种硬件，而应用程序只能被限制的访问硬件和内存地址）。</p>
<blockquote>
<p>以ARM处理器为例，除用户模式外，其余6种工作模式都属于特权模式：</p>
<p>用户模式（USR）：正常程序执行模式，不能直接切换到其他模式</p>
<p>系统模式（SYS）：运行操作系统的特权任务，与用户模式类似，但具有可以直接切换到其他模式等特权</p>
<p>快中断模式（FIQ）：支持高速数据传输及通道处理，FIQ异常响应时进入此模式</p>
<p>中断模式（IRQ）：用于通用中断处理，IRQ异常响应时进入此模式</p>
<p>管理模式（SVC）：操作系统保护模式，系统复位和软件中断响应时进入此模式（由系统调用执行软中断SWI命令触发）</p>
<p>中止模式（ABT）：用于支持虚拟内存和/或存储器保护，在ARM7TDMI没有大用处</p>
<p>未定义模式（UND）：支持硬件协处理器的软件仿真，未定义指令异常响应时进入此模式</p>
<p>Linux内核态是从ARM的SVC即管理模式下启动的，但在某些情况下、如：硬件中断、程序异常（被动）等情况下进入ARM的其他特权模式，这时仍然可以进入内核态（因为就是可以操作内核了）；同样，Linux用户态是从ARM用户模式启动的，但当进入ARM系统模式时、仍然可以操作Linux用户态程序（进入用户态，如init进程的启动过程）。</p>
<p>即：Linux内核从ARM的SVC模式下启动，但内核态不仅仅指ARM的SVC模式（还包括可以访问内核空间的所有ARM模式）；Linux用户程序从ARM的用户模式启动，但用户态不仅仅指ARM的用户模式。</p>
</blockquote>
<p>直观来看：uboot的镜像是u-boot.bin，Linux系统的镜像是zImage，这两个东西其实都是裸机程序镜像。从系统启动的角度来讲，内核和uboot都是裸机程序。</p>
<h2 id="文件系统"><a class="markdownIt-Anchor" href="#文件系统"></a> 文件系统</h2>
<h3 id="概念"><a class="markdownIt-Anchor" href="#概念"></a> 概念</h3>
<p>Linux文件系统中的文件是数据的集合，文件系统不仅包含着文件中的数据而且还有文件系统的结构，所有Linux 用户和程序看到的文件、目录、软连接及文件保护信息等都存储在其中。这种机制有利于用户和操作系统的交互。</p>
<p>尽管内核是 Linux 的核心，但文件却是用户与操作系统交互所采用的主要工具。这对 Linux 来说尤其如此，这是因为在 UNIX 传统中，它使用文件 I/O 机制管理硬件设备和数据文件</p>
<h3 id="虚拟文件系统-根文件系统和文件系统"><a class="markdownIt-Anchor" href="#虚拟文件系统-根文件系统和文件系统"></a> 虚拟文件系统、根文件系统和文件系统</h3>
<h3 id="vfs"><a class="markdownIt-Anchor" href="#vfs"></a> VFS：</h3>
<p>Linux支持多种文件系统类型，因为它将底层与应用层分隔开；而提供统一的接口支持应用层对于不同实现的文件系统的访问，这个统一的接口称为虚拟文件系统VFS。</p>
<p>kernel中以VFS去支持各种文件系统，如yaffs，ext3，cramfs等等。yaffs/yaffs2是专为<a target="_blank" rel="noopener external nofollow noreferrer" href="https://so.csdn.net/so/search?q=%E5%B5%8C%E5%85%A5%E5%BC%8F&amp;spm=1001.2101.3001.7020">嵌入式</a>系统使用NAND型闪存而设计的一种日志型文件系统。在内核中以VFS来屏蔽各种文件系统的接口不同，以VFS向kernel提供一个统一的接口。</p>
<h3 id="根文件系统"><a class="markdownIt-Anchor" href="#根文件系统"></a> 根文件系统</h3>
<p>文件系统指文件存在的物理空间，linux系统中每个分区都是一个文件系统，都有自己的目录层次结构。以“/”为顶级目录的文件系统称为根文件系统。</p>
<p>Linux启动时，第一个必须挂载的是根文件系统；若系统不能从指定设备上挂载根文件系统，则系统会出错而退出启动。系统正常挂载根文件系统之后可以自动或手动挂载其他的文件系统（根文件系统是其他文件的最终挂载点）。因此，一个系统中可以同时存在不同的文件系统。</p>
<blockquote>
<p>也就是说：</p>
<p>根文件系统可以是任何kernel支持的文件系统类型(ext4,yaffs等)。</p>
<p>但它必须包含linux内核启动时所必需的文件(根文件系统必需存在的目录 /dev /bin /sbin 等等)，不然系统启动会失败。</p>
<p>根文件系统是之所以有个根(/)字,是因为它是linux系统启动时挂载(mount,所谓挂载：就是在内存中创建一个虚拟的文件对应具体的存储空间分区的过程,挂载时不会保存信息,下次启动时得重新挂载)的第一个文件系统,启动完成后可以自动(配置etc/fstab)或者手动的方式将其它文件系统(分区)挂载到根文件系统中。</p>
</blockquote>
<h3 id="其他文件系统"><a class="markdownIt-Anchor" href="#其他文件系统"></a> 其他文件系统</h3>
<p>不同的文件系统类型有不同的特点，因而根据存储设备的硬件特性、系统需求等有不同的应用场合。在嵌入式Linux应用中，主要的存储设备为 RAM(DRAM, SDRAM)和ROM(常采用FLASH存储器)，常用的基于存储设备的文件系统类型包括：jffs2, yaffs, cramfs, romfs, ramdisk,initramfs, ramfs/tmpfs,ubifs等。</p>
<h3 id="uboot与根文件系统的关系"><a class="markdownIt-Anchor" href="#uboot与根文件系统的关系"></a> uboot与根文件系统的关系</h3>
<p>早期的uboot没有分区的概念，uboot只知道应该将什么数据烧写到存储介质的什么区间中。</p>
<p>（也就是说，对于uboot来看，只有起始地址结束地址等，A～B地址放内核，C～D地址放文件系统，即：规定哪个地址区间放内核或者文件系统等）</p>
<p>虽然此后，uboot中渐渐也有了MTD等管理分区部分的功能。尽管如此，不影响我们的学习理解。</p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<p>cpu首先执行位于0地址的uboot，uboot启动以后初始化一些资源，告诉内核有关的参数并引导内核，内核通过事先添加对于某种文件系统类型的支持驱动（相当于一小段程序），读取uboot等boot loader在指定的区域烧写制作好的文件系统镜像，内核解析并挂载成根文件系统，并在此基础上，通过VFS再挂载不同的文件系统类型，完成启动以后，再去管理有关的资源（包括应用程序）</p>
<h1 id="应用编程"><a class="markdownIt-Anchor" href="#应用编程"></a> 应用编程</h1>
<h2 id="framebufferioctl-mmap"><a class="markdownIt-Anchor" href="#framebufferioctl-mmap"></a> Framebuffer(ioctl  mmap)</h2>
<p>bpp: 每个像素用多少位来表示它的颜色</p>
<p><strong>首地址+偏移地址=确定出位于哪里</strong></p>
<p>假设fb_base是APP执行mmap后得到的Framebuffer地址</p>
<p>求偏移地址: <code>y*line_width+x*pixel_width(这就时偏移地址) + fb_base = 绝对地址</code></p>
<p>可以用以下公式算出(x,y)坐标处像素对应的Framebuffer地址：</p>
<p>(x，y)像素起始地址=fb_base+(xres*bpp/8)<em>y + x</em>bpp/8</p>
<p>一行的宽度: <code>xres * bpp/8</code> 一个像素宽度: <code>bpp/8</code></p>
<h3 id="ioctl"><a class="markdownIt-Anchor" href="#ioctl"></a> ioctl</h3>
<p>ioctl是设备驱动程序中对设备的I/O通道进行管理的函数 。所谓对I/O通道进行管理，就是对设备的一些特性进行控制</p>
<p>ioctl函数是文件结构中的一个属性分量，就是说如果你的驱动程序提供了对ioctl的支持，用户就可以在用户程序中使用ioctl函数来控制设备的I/O通道。</p>
<p>头文件：<code>#include &lt;sys/ioctl.h&gt;</code></p>
<p>函数原型： <code>int ioctl(int fd, unsigned long request, ...);</code></p>
<p>函数说明：</p>
<p>① fd 表示文件描述符；</p>
<p>② request表示与驱动程序交互的命令，用不同的命令控制驱动程序输出我们需要的数据；</p>
<p>③ … 表示可变参数arg，根据request命令，设备驱动程序返回输出的数据。</p>
<p>④ 返回值：打开成功返回文件描述符，失败将返回-1。</p>
<p>ioctl的作用非常强大、灵活。不同的驱动程序内部会实现不同的ioctl，APP可以使用各种ioctl跟驱动程序交互：可以传数据给驱动程序，也可以从驱动程序中读出数据。</p>
<h3 id="mmap"><a class="markdownIt-Anchor" href="#mmap"></a> mmap</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line">函数原型：</span><br><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags,<span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"></span><br><span class="line">函数说明：</span><br><span class="line">① addr表示指定映射的內存起始地址，通常设为 <span class="literal">NULL</span>表示让系统自动选定地址，并在成功映射后返回该地址；</span><br><span class="line">② length表示将文件中多大的内容映射到内存中；</span><br><span class="line">③ prot 表示映射区域的保护方式，可以为以下<span class="number">4</span>种方式的组合</span><br><span class="line">a. PROT_EXEC 映射区域可被执行</span><br><span class="line">b. PROT_READ 映射区域可被读出</span><br><span class="line">c. PROT_WRITE 映射区域可被写入</span><br><span class="line">d. PROT_NONE 映射区域不能存取</span><br><span class="line">④ Flags 表示影响映射区域的不同特性，常用的有以下两种</span><br><span class="line">a. MAP_SHARED 表示对映射区域写入的数据会复制回文件内，原来的文件会改变。</span><br><span class="line">b. MAP_PRIVATE 表示对映射区域的操作会产生一个映射文件的复制，对此区域的任何修改都不会写回原来的文件内容中。</span><br><span class="line">⑤ 返回值：若成功映射，将返回指向映射的区域的指针，失败将返回<span class="number">-1</span>。</span><br></pre></td></tr></tbody></table></figure>
<p>映射framebuffer, framebuffer时驱动程序分配的, 应用程序想要去使用必须使用mmap映射到用户空间, 应用程序得到LCD的参数并且得到framebuffer的地址之后就可以在上面操作了.</p>
<p>描点函数demo:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">28</span> <span class="type">void</span> <span class="title function_">lcd_put_pixel</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">unsigned</span> <span class="type">int</span> color(传入RGB888))</span></span><br><span class="line">29 {</span><br><span class="line"><span class="number">30</span>      <span class="type">unsigned</span> <span class="type">char</span> *pen_8 = fb_base+y*line_width+x*pixel_width;</span><br><span class="line"><span class="number">31</span>      <span class="type">unsigned</span> <span class="type">short</span> *pen_16;</span><br><span class="line"><span class="number">32</span>      <span class="type">unsigned</span> <span class="type">int</span> *pen_32;</span><br><span class="line"><span class="number">33</span></span><br><span class="line"><span class="number">34</span>      <span class="type">unsigned</span> <span class="type">int</span> red, green, blue;</span><br><span class="line"><span class="number">35</span></span><br><span class="line"><span class="number">36</span>      pen_16 = (<span class="type">unsigned</span> <span class="type">short</span> *)pen_8;</span><br><span class="line"><span class="number">37</span>      pen_32 = (<span class="type">unsigned</span> <span class="type">int</span> *)pen_8;</span><br><span class="line"><span class="number">38</span></span><br><span class="line"><span class="number">39</span>      <span class="keyword">switch</span> (var.bits_per_pixel)</span><br><span class="line"><span class="number">40</span>      {</span><br><span class="line"><span class="number">41</span>              <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line"><span class="number">42</span>              {</span><br><span class="line"><span class="number">43</span>                      *pen_8 = color;</span><br><span class="line"><span class="number">44</span>                      <span class="keyword">break</span>;</span><br><span class="line"><span class="number">45</span>              }</span><br><span class="line"><span class="number">46</span>              <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line"><span class="number">47</span>              {</span><br><span class="line"><span class="number">48</span>                      <span class="comment">/* 565 */</span></span><br><span class="line"><span class="number">49</span>                      red   = (color &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line"><span class="number">50</span>                      green = (color &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line"><span class="number">51</span>                      blue  = (color &gt;&gt; <span class="number">0</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line"><span class="number">52</span>                      color = ((red &gt;&gt; <span class="number">3</span>) &lt;&lt; <span class="number">11</span>) | ((green &gt;&gt; <span class="number">2</span>) &lt;&lt; <span class="number">5</span>) | (blue &gt;&gt;                         <span class="number">3</span>);<span class="comment">//保证绿颜色高六位 //保证蓝颜色高五位</span></span><br><span class="line"><span class="number">53</span>                      *pen_16 = color;</span><br><span class="line"><span class="number">54</span>                      <span class="keyword">break</span>;</span><br><span class="line"><span class="number">55</span>              }</span><br><span class="line"><span class="number">56</span>              <span class="keyword">case</span> <span class="number">32</span>:</span><br><span class="line"><span class="number">57</span>              {</span><br><span class="line"><span class="number">58</span>                      *pen_32 = color;</span><br><span class="line"><span class="number">59</span>                      <span class="keyword">break</span>;</span><br><span class="line"><span class="number">60</span>              }</span><br><span class="line"><span class="number">61</span>              <span class="keyword">default</span>:</span><br><span class="line"><span class="number">62</span>              {</span><br><span class="line"><span class="number">63</span>                      <span class="built_in">printf</span>(<span class="string">"can't surport %dbpp\n"</span>, var.bits_per_pixel);</span><br><span class="line"><span class="number">64</span>                      <span class="keyword">break</span>;</span><br><span class="line"><span class="number">65</span>              }</span><br><span class="line"><span class="number">66</span>      }</span><br><span class="line"><span class="number">67</span> }</span><br><span class="line">第<span class="number">28</span>行中传入的color表示颜色，它的格式永远是<span class="number">0x00</span>RRGGBB，即RGB888。当LCD是<span class="number">16b</span>pp时，要把color变量中的R、G、B抽出来再合并成RGB565格式。</span><br><span class="line">第<span class="number">30</span>行计算(x,y)坐标上像素对应的Framebuffer地址。</span><br><span class="line">第<span class="number">43</span>行，对于<span class="number">8b</span>pp，color就不再表示RBG三原色了，这涉及调色板的概念，color是调色板的值。</span><br><span class="line">第<span class="number">49</span>～<span class="number">51</span>行，先从color变量中把R、G、B抽出来。</span><br><span class="line">第<span class="number">52</span>行，把red、green、blue这三种<span class="number">8</span>位颜色值，根据RGB565的格式，只保留red中的高<span class="number">5</span>位、green中的高<span class="number">6</span>位、blue中的高<span class="number">5</span>位，组合成一个新的<span class="number">16</span>位颜色值。</span><br><span class="line">第<span class="number">53</span>行，把新的<span class="number">16</span>位颜色值写入Framebuffer。</span><br><span class="line">第<span class="number">58</span>行，对于<span class="number">32b</span>pp，颜色格式跟color参数一致，可以直接写入Framebuffer。</span><br><span class="line">   </span><br><span class="line"> <span class="comment">/* 清屏: 全部设为白色 */</span></span><br><span class="line"><span class="number">96</span>      <span class="built_in">memset</span>(fbmem, <span class="number">0xff</span>, screen_size);</span><br><span class="line"><span class="number">97</span></span><br><span class="line"><span class="number">98</span>      <span class="comment">/* 随便设置出100个为红色 */</span></span><br><span class="line"><span class="number">99</span>      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line"><span class="number">100</span>             lcd_put_pixel(var.xres/<span class="number">2</span>+i, var.yres/<span class="number">2</span>, <span class="number">0xFF0000</span>);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="文字显示"><a class="markdownIt-Anchor" href="#文字显示"></a> 文字显示</h2>
<h3 id="字符编码"><a class="markdownIt-Anchor" href="#字符编码"></a> 字符编码</h3>
<p><code>ASCII</code> 常用字母就26个，区分大小写、加上标点符号也没超过127个，每个字符用一个字节来表示就足够了。一个字节的7位就可以表示128个数值，在ASCII码中最高位永远是0。</p>
<p><img src="https://pic.imgdb.cn/item/6282470109475431294c9869.png" alt=""></p>
<p><code>ANSI</code> ASNI是ASCII的扩展，向下包含ASCII。对于ASCII字符仍以一个字节来表示，对于非ASCII字符则使用2字节来表示。</p>
<p>在中国大陆地区，ANSI的默认编码是GB2312；在港澳台地区默认编码是BIG5。以数值“0xd0d6”为例，对于GB2312编码它表示“中”；对于BIG5编码它表示“笢”。所以对于ANSI编码的TXT文件，如果你打开它发现乱码，那么还得再次细分它的具体编码。</p>
<p><code>UNICODE</code></p>
<p>在ANSI标准中，很多种文字都有自己的编码标准，汉字简体字有GB2312、繁体字有BIG5，这难免同一个数值对应不同字符。比如数值“0xd0d6”，对于GB2312编码它表示“中”；对于BIG5编码它表示“笢”。这造成了使用ANSI编码保存的文件，不适合跨地区交流。</p>
<p>UNICODE编码就是解决这类问题：对于地球上任意一个字符，都给它一个唯一的数值。</p>
<p>UNICODE仍然向下兼容ASCII，但是对于其他字符会有对应的数值，比如对于“中”、“笢”，它们的数值分别是：0x4e2d、0x7b22</p>
<p>UNICODE中的数值范围是0x0000至0x10FFFF，有1,114,111即100多万个数值，可以表示100多万个字符，足够地球人使用了。</p>
<h3 id="ascii字符显示"><a class="markdownIt-Anchor" href="#ascii字符显示"></a> ASCII字符显示</h3>
<p><img src="https://pic.imgdb.cn/item/6282594b09475431299abf28.png" alt=""></p>
<h3 id="中文字符显示"><a class="markdownIt-Anchor" href="#中文字符显示"></a> 中文字符显示</h3>
<p>如果不指定“-finput-charset”，GCC就会默认C程序的编码方式为UTF-8，即使你是以ANSI格式保存，也会被当作UTF-8来对待。</p>
<p>对于编译出来的可执行程序，可以指定它里面的字符是以什么方式编码，可以使用以下的选项编译器：</p>
<p><code>-fexec-charset=GB231</code></p>
<p><code>-fexec-charset=UTF-8</code></p>
<p>如果不指定“-fexec-charset”，GCC就会默认编译出的可执行程序中字符的编码方式为UTF-8。</p>
<p>如果“-finput-charset”与“-fexec-charset”不一样，编译器会进行格式转换。</p>
<p>待补充…</p>
<h3 id="交叉编译程序以freetype为例"><a class="markdownIt-Anchor" href="#交叉编译程序以freetype为例"></a> 交叉编译程序：以freetype为例</h3>
<p>使用buildroot来给ARM板编译程序、编译库会很简单,这里freetype在编译 安装一些小程序很有用</p>
<h4 id="库相关知识"><a class="markdownIt-Anchor" href="#库相关知识"></a> 库相关知识</h4>
<ol>
<li>
<p>编译程序时去哪找头文件？</p>
<p>系统目录：就是交叉编译工具链里的某个include目录；</p>
<p>也可以自己指定：编译时用 “ -I dir ”选项指定。</p>
</li>
<li>
<p>链接时去哪找库文件？</p>
<p>系统目录：就是交叉编译工具链里的某个lib目录；</p>
<p>也可以自己指定：链接时用 “ -L dir ”选项指定。</p>
</li>
<li>
<p>运行时去哪找库文件？</p>
<p>系统目录：就是板子上的/lib、/usr/lib目录；</p>
<p>也可以自己指定：运行程序用环境变量LD_LIBRARY_PATH指定。</p>
</li>
<li>
<p>运行时不需要头文件，所以头文件不用放到板子上</p>
</li>
</ol>
<p><strong>库的问题</strong>  这是链接程序时出现的问题</p>
<p>系统目录：就是交叉编译工具链里的某个lib目录, 也可以自己指定：链接时用 <code>-L dir</code>选项指定</p>
<p>怎么确定“系统目录”？执行下面命令确定目录：</p>
<p><code>echo 'main(){}'| arm-buildroot-linux-gnueabihf-gcc -E -v –</code></p>
<p>它会列出头文件目录、库目录(LIBRARY_PATH)，你编译出库文件时，可以把它放入系统库目录。</p>
<p><strong>运行问题</strong></p>
<p>系统目录：就是板子上的/lib、/usr/lib目录</p>
<p>也可以自己指定：  运行程序用环境变量LD_LIBRARY_PATH指定，执行以下的命令</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export  LD_LIBRARY_PATH=/xxx_dir  ;  ./test</span><br><span class="line">或</span><br><span class="line">LD_LIBRARY_PATH=/xxx_dir   ./test</span><br></pre></td></tr></tbody></table></figure>
<h4 id="交叉编译"><a class="markdownIt-Anchor" href="#交叉编译"></a> 交叉编译</h4>
<p>如果交叉编辑工具链的前缀是arm-buildroot-linux-gnueabihf-，比如arm-buildroot-linux-gnueabihf-gcc，交叉编译开源软件时，如果它里面有configure</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure  --host=arm-buildroot-linux-gnueabihf(这里自己修改)   --prefix=$PWD/tmp</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></tbody></table></figure>
<p>就可以在当前目录的tmp目录下看见bin, lib, include等目录，里面存有可执行程序、库、头文件。</p>
<p>程序运行不需要头文件</p>
<h3 id="freetype"><a class="markdownIt-Anchor" href="#freetype"></a> freetype</h3>
<p>Freetype是开源的字体引擎库，它提供统一的接口来访问多种字体格式文件，从而实现矢量字体显示。我们只需要移植这个字体引擎，调用对应的API接口，提供字体文件，就可以让freetype库帮我们取出关键点、实现闭合曲线，填充颜色，达到显示矢量字体的目的。</p>
<p>一个文字的显示过程可以概括如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">① 给定一个字符可以确定它的编码值(ASCII、UNICODE、GB2312)；</span><br><span class="line"></span><br><span class="line">② 设置字体大小；</span><br><span class="line"></span><br><span class="line">③ 根据编码值，从文件头部中通过charmap找到对应的关键点(glyph)，它会根据字体大小调整关键点；</span><br><span class="line"></span><br><span class="line">④ 把关键点转换为位图点阵；</span><br><span class="line"></span><br><span class="line">⑤ 在LCD上显示出来</span><br></pre></td></tr></tbody></table></figure>
<p><strong>如何使用freetype库，总结出下列步骤：</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">① 初始化：FT_InitFreetype</span><br><span class="line"></span><br><span class="line">② 加载(打开)字体Face：FT_New_Face</span><br><span class="line"></span><br><span class="line">③ 设置字体大小：FT_Set_Char_Sizes 或 FT_Set_Pixel_Sizes</span><br><span class="line"></span><br><span class="line">④ 选择charmap：FT_Select_Charmap</span><br><span class="line"></span><br><span class="line">⑤ 根据编码值charcode找到glyph_index：glyph_index = FT_Get_Char_Index（face，charcode）</span><br><span class="line"></span><br><span class="line">⑥ 根据glyph_index取出glyph：FT_Load_Glyph（face，glyph_index）</span><br><span class="line"></span><br><span class="line">⑦ 转为位图：FT_Render_Glyph</span><br><span class="line"></span><br><span class="line">⑧ 移动或旋转:FT_Set_Transform</span><br><span class="line"></span><br><span class="line">⑨ 最后显示出来。</span><br></pre></td></tr></tbody></table></figure>
<p>上面的⑤⑥⑦可以使用一个函数代替：FT_Load_Char(face, charcode, FT_LOAD_RENDER)，它就可以得到位图。</p>
<p>demo:</p>
<p>如果想在代码中能直接使用UNICODE值，需要使用wchar_t，宽字符, 占四个字节</p>
<p>注意：如果test_wchar.c是以ANSI(GB2312)格式保存，那么需要使用以下命令来编译：</p>
<p><code>gcc -finput-charset=GB2312 -fexec-charset=UTF-8 -o test_wchar test_wchar.c</code></p>
<p><strong>显示一行文字</strong></p>
<p>笛卡尔坐标系:</p>
<p>在LCD的坐标系中，原点在屏幕的左上角。对于笛卡尔坐标系，原点在左下角。freetype使用笛卡尔坐标系，在显示时需要转换为LCD坐标系。</p>
<p>从下图可知，X方向坐标值是一样的。</p>
<p>在Y方向坐标值需要换算，<code>假设LCD的高度是V</code>。</p>
<p>在LCD坐标系中坐标是(x, y)，那么它在笛卡尔坐标系中的坐标值为(x, V-y)。</p>
<p>反过来也是一样的，在笛卡尔坐标系中坐标是(x, y)，那么它在LCD坐标系中坐标值为(x, V-y)。</p>
<img src="https://pic.imgdb.cn/item/6283d6de0947543129e1b268.png" style="zoom:67%;">
<p><code>具体函数见文档393页.</code></p>
<h2 id="输入系统"><a class="markdownIt-Anchor" href="#输入系统"></a> 输入系统</h2>
<p>外设都是输入设备,Linux系统为了统一管理这些输入设备，实现了一套能兼容所有输入设备的框架：输入系统。驱动开发人员基于这套框架开发出程序，应用开发人员就可以使用统一的API去使用设备。</p>
<h3 id="框架"><a class="markdownIt-Anchor" href="#框架"></a> 框架</h3>
<p><img src="https://pic.imgdb.cn/item/6283da1a0947543129ec9715.png" alt=""></p>
<p>假设用户程序直接访问/dev/input/event0设备节点，或者使用tslib访问设备节点，数据的流程如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">① APP发起读操作，若无数据则休眠；</span><br><span class="line">② 用户操作设备，硬件上产生中断；</span><br><span class="line">③ 输入系统驱动层对应的驱动程序处理中断：</span><br><span class="line">    读取到数据，转换为标准的输入事件，向核心层汇报。</span><br><span class="line">    所谓输入事件就是一个“struct input_event”结构体。</span><br><span class="line">④ 核心层可以决定把输入事件转发给上面哪个handler来处理：</span><br><span class="line">    从handler的名字来看，它就是用来处输入操作的。有多种handler，比如：evdev_handler(常用)、	kbd_handler、joydev_handler等等。</span><br><span class="line">    最常用的是evdev_handler：它只是把input_event结构体保存在内核buffer等，APP来读取时就原原本本地返回。它支持多个APP同时访问输入设备，每个APP都可以获得同一份输入事件。</span><br><span class="line">    当APP正在等待数据时，evdev_handler会把它唤醒，这样APP就可以返回数据。</span><br><span class="line">⑤ APP对输入事件的处理：</span><br><span class="line">    APP获得数据的方法有2种：直接访问设备节点(比如/dev/input/event0,1,2,...)，或者通过tslib、libinput这类库来间接访问设备节点。这些库简化了对数据的处理。</span><br></pre></td></tr></tbody></table></figure>
<p><strong>内核中怎么表示一个输入设备？</strong>  使用input_dev结构体来表示输入设备，它的内容如下：</p>
<p><img src="https://pic.imgdb.cn/item/6283ed3b094754312925c1e9.jpg" alt=""></p>
<p>驱动程序上报的数据含义三项重要内容</p>
<ul>
<li>
<p><code>type</code> 表示数据是哪一类型的, 比如EV_KEY(表示按键类)  <strong>当type=0表示是同步事件</strong> 表示硬件已经上报了所有数据</p>
</li>
<li>
<p><code>code</code> 按键类事件里面是哪一个按键? 硬件上报的是哪个按键</p>
</li>
<li>
<p><code>value</code> 值, 比如0(松开) 1(按下) 2(长按)</p>
</li>
<li>
<p>事件之间的界线</p>
<p>APP读取数据时，可以得到一个或多个数据，比如一个触摸屏的一个触点会上报X、Y位置信息，也可能会上报压力值。</p>
<p>APP怎么知道它已经读到了完整的数据？</p>
<p>驱动程序上报完一系列的数据后，会上报一个“同步事件”，表示数据上报完毕。APP读到“同步事件”时，就知道已经读完了当前的数据。</p>
</li>
</ul>
<p>得到一系列的输入事件，就是一个一个“struct input_event”，它定义如下：</p>
<p><img src="https://pic.imgdb.cn/item/6283e6b3094754312914944d.jpg" alt=""></p>
<p>每个输入事件input_event中都含有发生时间：timeval表示的是“自系统启动以来过了多少时间”，它是一个结构体，含有“tv_sec、tv_usec”两项(即秒、微秒)。</p>
<h4 id="调试技巧"><a class="markdownIt-Anchor" href="#调试技巧"></a> 调试技巧</h4>
<p>入设备的设备节点名为/dev/input/eventX(也可能是/dev/eventX，X表示0、1、2等数字)。查看设备节点，可以执行以下命令： <code>ls /dev/input/* -l</code> 或 <code>ls /dev/event* -l</code></p>
<p>怎么知道这些设备节点对应什么硬件呢？可以在板子上执行以下命令： <code>cat /proc/bus/input/devices</code></p>
<p>这条指令的含义就是获取与event对应的相关设备信息，可以看到类似以下的结果：</p>
<p><img src="https://pic.imgdb.cn/item/6283ebfd0947543129229387.jpg" alt=""></p>
<p>这里的I、N、P、S、U、H、B对应的每一行是什么含义:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">I:id of the device(设备ID) 该参数由结构体struct input_id来进行描述</span><br><span class="line">N:name of the device 设备名称</span><br><span class="line">P:physical path to the device in the system hierarchy 系统层次结构中设备的物理路径。</span><br><span class="line">S:sysfs path 位于sys文件系统的路径</span><br><span class="line">U:unique identification code for the device(if device has it) 设备的唯一标识码</span><br><span class="line">H:list of input handles associated with the device. 与设备关联的输入句柄列表。</span><br><span class="line">B:bitmaps(位图)</span><br><span class="line">    PROP:device properties and quirks(设备属性)</span><br><span class="line">    EV:types of events supported by the device(设备支持的事件类型)</span><br><span class="line">    KEY:keys/buttons this device has(此设备具有的键/按钮)</span><br><span class="line">    MSC:miscellaneous events supported by the device(设备支持的其他事件)</span><br><span class="line">    LED:leds present on the device(设备上的指示灯)</span><br></pre></td></tr></tbody></table></figure>
<p>比如上图中“B: EV=b”用来表示该设备支持哪类输入事件。b的二进制是1011，bit0、1、3为1，表示该设备支持0、1、3这三类事件，即EV_SYN、EV_KEY、EV_ABS。</p>
<p>再举一个例子，“B: ABS=2658000 3”如何理解？</p>
<p>它表示该设备支持EV_ABS这一类事件中的哪一些事件。这是2个32位的数字：0x2658000、0x3，高位在前低位在后，组成一个64位的数字：“0x2658000,00000003”，数值为1的位有：0、1、47、48、50、53、54，即：0、1、0x2f、0x30、0x32、0x35、0x36,对应一些宏.</p>
<p><strong>命令读取</strong></p>
<p>调试输入系统时，直接执行类似下面的命令，然后操作对应的输入设备即可读出数据： <code>hexdump /dev/input/event0</code></p>
<p><img src="https://pic.imgdb.cn/item/628466520947543129b4b595.jpg" alt=""></p>
<p>上图中的type为3，对应EV_ABS；code为0x35对应ABS_MT_POSITION_X；code为0x36对应ABS_MT_POSITION_Y。</p>
<p>上图中还发现有2个同步事件：它的type、code、value都为0。表示电容屏上报了2次完整的数据。</p>
<h4 id="不用库开发应用"><a class="markdownIt-Anchor" href="#不用库开发应用"></a> 不用库开发应用</h4>
<p>输入系统支持完整的API操作 :  支持这些机制：阻塞、非阻塞、POLL/SELECT、异步通知。</p>
<p><strong>APP访问硬件的几种方式</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">① 时不时进房间看一下：查询方式</span><br><span class="line">简单，但是累</span><br><span class="line">② 进去房间陪小孩一起睡觉，小孩醒了会吵醒她：休眠-唤醒</span><br><span class="line">不累，但是妈妈干不了活了</span><br><span class="line">③ 妈妈要干很多活，但是可以陪小孩睡一会，定个闹钟：poll方式</span><br><span class="line">要浪费点时间，但是可以继续干活。</span><br><span class="line">妈妈要么是被小孩吵醒，要么是被闹钟吵醒。</span><br><span class="line">④ 妈妈在客厅干活，小孩醒了他会自己走出房门告诉妈妈：异步通知</span><br><span class="line">妈妈、小孩互不耽误。</span><br></pre></td></tr></tbody></table></figure>
<p>通过ioctl获取设备信息，ioctl的参数如下： <code>int ioctl(int fd, unsigned long request, ...);</code></p>
<h5 id="查询方式"><a class="markdownIt-Anchor" href="#查询方式"></a> 查询方式</h5>
<p>APP调用open函数时，传入“O_NONBLOCK”表示“非阻塞”。</p>
<p>APP调用read函数读取数据时，如果驱动程序中有数据，那么APP的read函数会返回数据，否则也会立刻返回错误。</p>
<h5 id="休眠-唤醒方式"><a class="markdownIt-Anchor" href="#休眠-唤醒方式"></a> 休眠-唤醒方式</h5>
<p>APP调用open函数时，不要传入“O_NONBLOCK”。</p>
<p>APP调用read函数读取数据时，如果驱动程序中有数据，那么APP的read函数会返回数据；否则APP就会在内核态休眠，当有数据时驱动程序会把APP唤醒，read函数恢复执行并返回数据给APP。</p>
<h5 id="pollselect方式"><a class="markdownIt-Anchor" href="#pollselect方式"></a> POLL/SELECT方式</h5>
<p>POLL机制、SELECT<code>机制</code>是完全一样的，只是APP接口函数不一样。在调用poll、select函数时可以传入“超时时间”。在这段时间内，条件合适时(比如有数据可读、有空间可写)就会立刻返回，否则等到“超时时间”结束时返回错误。</p>
<p>APP先调用open函数时。APP不是直接调用read函数，而是先调用poll或select函数，这2个函数中可以传入“超时时间”。它们的作用是：如果驱动程序中有数据，则立刻返回；否则就休眠。在休眠期间，如果有人操作了硬件，驱动程序获得数据后就会把APP唤醒，导致poll或select立刻返回；如果在“超时时间”内无人操作硬件，则时间到后poll或select函数也会返回。</p>
<p>poll/select函数可以监测多个文件，可以监测多种事件：</p>
<table>
<thead>
<tr>
<th>事件类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>POLLIN</td>
<td>有数据可读</td>
</tr>
<tr>
<td>POLLRDNORM</td>
<td>等同于POLLIN</td>
</tr>
<tr>
<td>POLLRDBAND</td>
<td>Priority band data can be read，有优先级较较高的“band  data”可读  Linux系统中很少使用这个事件</td>
</tr>
<tr>
<td>POLLPRI</td>
<td>高优先级数据可读</td>
</tr>
<tr>
<td>POLLOUT</td>
<td>可以写数据</td>
</tr>
<tr>
<td>POLLWRNORM</td>
<td>等同于POLLOUT</td>
</tr>
<tr>
<td>POLLWRBAND</td>
<td>Priority data may be written</td>
</tr>
<tr>
<td>POLLERR</td>
<td>发生了错误</td>
</tr>
<tr>
<td>POLLHUP</td>
<td>挂起</td>
</tr>
<tr>
<td>POLLNVAL</td>
<td>无效的请求，一般是fd未open</td>
</tr>
</tbody>
</table>
<p>在调用poll函数时，要指明：</p>
<p>① 你要监测哪一个文件：哪一个fd</p>
<p>② 你想监测这个文件的哪种事件：是POLLIN、还是POLLOUT</p>
<p>最后，在poll函数返回时，要判断状态。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">代码补充</span><br></pre></td></tr></tbody></table></figure>
<h4 id="异步通知方式"><a class="markdownIt-Anchor" href="#异步通知方式"></a> 异步通知方式</h4>
<p>所谓异步通知，就是APP可以忙自己的事，当驱动程序用数据时它会主动给APP发信号，这会导致APP执行信号处理函数。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">① 谁发：驱动程序发</span><br><span class="line">② 发什么：信号</span><br><span class="line">③ 发什么信号：SIGIO</span><br><span class="line">④ 怎么发：内核里提供有函数</span><br><span class="line">⑤ 发给谁：APP，APP要把自己告诉驱动</span><br><span class="line">⑥ APP收到后做什么：执行信号处理函数</span><br><span class="line">⑦ 信号处理函数和信号，之间怎么挂钩：APP注册信号处理函数</span><br></pre></td></tr></tbody></table></figure>
<p>除了注册SIGIO的处理函数，APP还要做什么事？想想这几个问题：</p>
<p>① 内核里有那么多驱动，你想让哪一个驱动给你发SIGIO信号？</p>
<p>APP要打开驱动程序的设备节点。</p>
<p>② 驱动程序怎么知道要发信号给你而不是别人？</p>
<p>APP要把自己的进程ID告诉驱动程序。</p>
<p>③ APP有时候想收到信号，有时候又不想收到信号：</p>
<p>应该可以把APP的意愿告诉驱动：设置Flag里面的FASYNC位为1，使能“异步通知”。</p>
<h3 id="tslib"><a class="markdownIt-Anchor" href="#tslib"></a> tslib</h3>
<p>tslib是一个触摸屏的开源库，可以使用它来访问触摸屏设备，可以给输入设备添加各种“filter”(过滤器，就是各种处理)，地址是：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.tslib.org/%E3%80%82">http://www.tslib.org/。</a></p>
<p>编译tslib后，可以得到libts库，还可以得到各种工具：较准工具、测试工具。</p>
<p>具体待补充.</p>
<h2 id="网络通信"><a class="markdownIt-Anchor" href="#网络通信"></a> 网络通信</h2>
<p>数据传输，都有三个要素 ：源、目的、长度。</p>
<p>待补充</p>
<h2 id="多线程"><a class="markdownIt-Anchor" href="#多线程"></a> 多线程</h2>
<p>待补充</p>
<h2 id="串口"><a class="markdownIt-Anchor" href="#串口"></a> 串口</h2>
<p>UART：通用异步收发传输器（Universal Asynchronous Receiver/Transmitter)，简称串口</p>
<p><strong>参数</strong></p>
<ul>
<li>
<p>波特率：一般选波特率都会有9600,19200,115200等选项。其实意思就是每秒传输这么多个比特位数(bit)。</p>
</li>
<li>
<p>起始位:先发出一个逻辑”0”的信号，表示传输数据的开始。</p>
</li>
<li>
<p>数据位：可以是5~8位逻辑”0”或”1”。如ASCII码（7位），扩展BCD码（8位）。小端传输。</p>
</li>
<li>
<p>校验位：数据位加上这一位后，使得“1”的位数应为偶数(偶校验)或奇数(奇校验)，以此来校验数据传送的正确性。</p>
</li>
<li>
<p>停止位：它是一个字符数据的结束标志。</p>
</li>
</ul>
<p><strong>如何发送数据</strong></p>
<img src="https://pic.imgdb.cn/item/6285e5cb09475431296c6968.jpg" style="zoom: 90%;">
<p>要发送数据时，CPU控制(UART单元)内存要发送的数据通过FIFO传给UART里面的移位器(诸位发送)，依次将数据发送出去，在发送完成后产生中断提醒CPU传输完成。</p>
<p>接收数据时，获取接收引脚的电平，逐位放进接收移位器，再放入FIFO，程序再从FIFO中把数据取出来写入内存。在接收完成后产生中断提醒CPU传输完成。</p>
<h3 id="tty体系中设备节点的差别"><a class="markdownIt-Anchor" href="#tty体系中设备节点的差别"></a> TTY体系中设备节点的差别</h3>
<table>
<thead>
<tr>
<th>设备节点</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>/dev/ttyS0、/dev/ttySAC0</td>
<td>串口</td>
</tr>
<tr>
<td>/dev/tty1、/dev/tty2、/dev/tty3、……</td>
<td>虚拟终端设备节点</td>
</tr>
<tr>
<td>/dev/tty0</td>
<td>前台终端</td>
</tr>
<tr>
<td>/dev/tty</td>
<td>程序自己的终端，可能是串口、也可能是虚拟终端</td>
</tr>
<tr>
<td>/dev/console</td>
<td>控制台，又内核的cmdline参数确定</td>
</tr>
</tbody>
</table>
<p>TTY /Terminal /Console /UART</p>
<p>下图中两条红线之内的代码被称为TTY子系统。它既支持UART，也支持键盘、显示器，还支持更复杂的功能(比如伪终端)</p>
<p>ctrl + alt +f4(x) 切换</p>
<img src="https://pic.imgdb.cn/item/6285ebf40947543129701b04.jpg">
<p>关于 /dev/ttyN   通过内核的cmdline来指定，比如: <code>console=ttyS0 console=tty</code></p>
<p>更多:</p>
<h3 id="tty驱动框架"><a class="markdownIt-Anchor" href="#tty驱动框架"></a> TTY驱动框架</h3>
<img src="https://pic.imgdb.cn/item/62863cf80947543129b0773e.jpg" style="zoom: 60%;">
<p>TTY这一层帮你屏蔽了不同输入输出设备的差别,串口 键盘等的驱动程序肯定会向上注册某个结构体, 再TTY这层使用同一个接口访问不同的设备</p>
<p>虚拟终端: 对于同一套键盘和显示器, 它可以对应不同的个虚拟终端, 对于虚拟终端又抽象出了一层 virtual terminal(串口没有这个) , 有很多个虚拟终端, 驱动程序得到键盘信息时会发送给前排的虚拟终端, 应用程序要显示的数据也会存入某一个buffer, 要显示时再从buffer中取出来,</p>
<h4 id="行规程"><a class="markdownIt-Anchor" href="#行规程"></a> 行规程</h4>
<img src="https://pic.imgdb.cn/item/628637070947543129ad4ff5.jpg" style="zoom: 50%;">
<p>也叫做回显 echo, 比较有意思 : 说的是在键盘上输入一个字符所发生的事情.</p>
<p>删除的话,删除命令(就是字节对应的编码) 发送到后,驱动上报行规成, 它把buf中的lsa删除掉a,然后将删除命令再发送回去, 所谓删除a只是显示效果, 串口工具还是接收到了4个字节的数据: l s a 退格键</p>
<p>回车键: 一样的,…, 将buf中的数据上传给APP(shell), 把结果再发给行规成,再发给串口驱动,然后PC显示.</p>
<h3 id="linux串口应用编程"><a class="markdownIt-Anchor" href="#linux串口应用编程"></a> Linux串口应用编程</h3>
<h4 id="串口怎么插"><a class="markdownIt-Anchor" href="#串口怎么插"></a> 串口怎么插</h4>
<img src="https://pic.imgdb.cn/item/628681f80947543129d1fddb.jpg" style="zoom: 80%;">
<img src="https://pic.imgdb.cn/item/62868c990947543129d578d7.jpg" style="zoom: 25%;">
<p>这个位置是串口,靠</p>
<h4 id="串口api"><a class="markdownIt-Anchor" href="#串口api"></a> 串口API</h4>
<p>在Linux系统中，操作设备的统一接口就是：open/ioctl/read/write。对于UART，又在ioctl之上封装了很多函数，主要是用来设置行规程。</p>
<p>所以对于UART，编程的套路就是：</p>
<p><code>open -&gt; 设置行规程，比如波特率、数据位、停止位、检验位、RAW模式、一有数据就返回 -&gt; read/write</code></p>
<p>怎么设置行规程？行规程的参数用结构体termios来表示,把这个结构体构造好之后再发给驱动程序.</p>
<img src="https://pic.imgdb.cn/item/628676540947543129cdaea1.jpg" style="zoom:50%;">
<p>这些函数在名称上有一些惯例：</p>
<p>`` tc：terminal contorl<code>   </code>cf: control flflag`</p>
<table>
<thead>
<tr>
<th><strong>函数名</strong></th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tcgetattr</td>
<td>get terminal attributes，获得终端的属性(获得驱动程序参数)</td>
</tr>
<tr>
<td>tcsetattr</td>
<td>set terminal attributes，修改终端参数</td>
</tr>
<tr>
<td>tcflflush</td>
<td>清空终端未完成的输入/输出请求及数据</td>
</tr>
<tr>
<td>cfsetispeed</td>
<td>sets the input baud rate，设置输入波特率</td>
</tr>
<tr>
<td>cfsetospeed</td>
<td>sets the output baud rate，设置输出波特率</td>
</tr>
<tr>
<td>cfsetspeed</td>
<td>同时设置输入、输出波特率</td>
</tr>
</tbody>
</table>
<p>需要设置好termios中的参数.</p>
<h4 id="实例回环"><a class="markdownIt-Anchor" href="#实例回环"></a> 实例(回环)</h4>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* set_opt(fd,115200,8,'N',1) */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_opt</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> nSpeed, <span class="type">int</span> nBits, <span class="type">char</span> nEvent, <span class="type">int</span> nStop)</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">newtio</span>,<span class="title">oldtio</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( tcgetattr( fd,&amp;oldtio) != <span class="number">0</span>) { <span class="comment">//获得驱动程序中默认的参数</span></span><br><span class="line">        perror(<span class="string">"SetupSerial 1"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//清除 使用原始模式</span></span><br><span class="line">    bzero( &amp;newtio, <span class="keyword">sizeof</span>( newtio ) );</span><br><span class="line">    newtio.c_cflag |= CLOCAL | CREAD; </span><br><span class="line">    newtio.c_cflag &amp;= ~CSIZE; </span><br><span class="line"></span><br><span class="line">    newtio.c_lflag  &amp;= ~(ICANON | ECHO | ECHOE | ISIG);  <span class="comment">/*Input*/</span></span><br><span class="line">    newtio.c_oflag  &amp;= ~OPOST;   <span class="comment">/*Output*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>( nBits )</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        newtio.c_cflag |= CS7;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">        newtio.c_cflag |= CS8;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>( nEvent )</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'O'</span>:</span><br><span class="line">        newtio.c_cflag |= PARENB;</span><br><span class="line">        newtio.c_cflag |= PARODD;</span><br><span class="line">        newtio.c_iflag |= (INPCK | ISTRIP);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'E'</span>: </span><br><span class="line">        newtio.c_iflag |= (INPCK | ISTRIP);</span><br><span class="line">        newtio.c_cflag |= PARENB;</span><br><span class="line">        newtio.c_cflag &amp;= ~PARODD;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'N'</span>: </span><br><span class="line">        newtio.c_cflag &amp;= ~PARENB;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>( nSpeed )</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2400</span>:</span><br><span class="line">        cfsetispeed(&amp;newtio, B2400);</span><br><span class="line">        cfsetospeed(&amp;newtio, B2400);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4800</span>:</span><br><span class="line">        cfsetispeed(&amp;newtio, B4800);</span><br><span class="line">        cfsetospeed(&amp;newtio, B4800);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">9600</span>:</span><br><span class="line">        cfsetispeed(&amp;newtio, B9600);</span><br><span class="line">        cfsetospeed(&amp;newtio, B9600);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">115200</span>:</span><br><span class="line">        cfsetispeed(&amp;newtio, B115200);</span><br><span class="line">        cfsetospeed(&amp;newtio, B115200);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        cfsetispeed(&amp;newtio, B9600);</span><br><span class="line">        cfsetospeed(&amp;newtio, B9600);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( nStop == <span class="number">1</span> )</span><br><span class="line">        newtio.c_cflag &amp;= ~CSTOPB;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( nStop == <span class="number">2</span> )</span><br><span class="line">        newtio.c_cflag |= CSTOPB;</span><br><span class="line">    </span><br><span class="line">    newtio.c_cc[VMIN]  = <span class="number">1</span>;  <span class="comment">/* 读数据时的最小字节数: 没读到这些数据我就不返回! */</span></span><br><span class="line">    newtio.c_cc[VTIME] = <span class="number">0</span>; <span class="comment">/* 等待第1个数据的时间: </span></span><br><span class="line"><span class="comment">                             * 比如VMIN设为10表示至少读到10个数据才返回,</span></span><br><span class="line"><span class="comment">                             * 但是没有数据总不能一直等吧? 可以设置VTIME(单位是10秒)</span></span><br><span class="line"><span class="comment">                             * 假设VTIME=1，表示: </span></span><br><span class="line"><span class="comment">                             *    10秒内一个数据都没有的话就返回</span></span><br><span class="line"><span class="comment">                             *    如果10秒内至少读到了1个字节，那就继续等待，完全读到VMIN个数据再返回</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line"></span><br><span class="line">    tcflush(fd,TCIFLUSH);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>((tcsetattr(fd,TCSANOW,&amp;newtio))!=<span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        perror(<span class="string">"com set error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//printf("set done!\n");</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">open_port</span><span class="params">(<span class="type">char</span> *com)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="comment">//fd = open(com, O_RDWR|O_NOCTTY|O_NDELAY);</span></span><br><span class="line">    fd = open(com, O_RDWR|O_NOCTTY);<span class="comment">//打开某个设备节点  O_NOCTTY:程序打开串口之后不要把这个串口用作控制终端(serial连接就是控制终端,输入字符转换成某些信号去控制)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == fd){</span><br><span class="line">        <span class="keyword">return</span>(<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//fcntl(fd,F_SETEL, FNDELAY); 读数据时不等待, 没有数据就返回0</span></span><br><span class="line">      <span class="keyword">if</span>(fcntl(fd, F_SETFL, <span class="number">0</span>)&lt;<span class="number">0</span>) <span class="comment">/* 设置串口为阻塞状态*/</span> <span class="comment">//读写数据不成功就会休眠</span></span><br><span class="line">      {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"fcntl failed!\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      }</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">return</span> fd;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ./serial_send_recv &lt;dev&gt;(设备节点)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> iRet;</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. open */</span><span class="comment">//打开</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. setup </span></span><br><span class="line"><span class="comment">     * 115200,8N1</span></span><br><span class="line"><span class="comment">     * RAW mode</span></span><br><span class="line"><span class="comment">     * return data immediately</span></span><br><span class="line"><span class="comment">     */</span><span class="comment">//设置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. write and read */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage: \n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s &lt;/dev/ttySAC1 or other&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    fd = open_port(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"open %s err!\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    iRet = set_opt(fd, <span class="number">115200</span>, <span class="number">8</span>, <span class="string">'N'</span>, <span class="number">1</span>);<span class="comment">//设置参数波特率11520 数据位8 不用校验位 停止位1</span></span><br><span class="line">    <span class="keyword">if</span> (iRet)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"set port err!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter a char: "</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;c);</span><br><span class="line">        iRet = write(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">        iRet = read(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (iRet == <span class="number">1</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"get: %02x %c\n"</span>, c, c);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"can not get data\n"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>读数据时的最小字节数设置为0: 为什么第一遍打印俩遍错误呢?</strong></p>
<p>输入a, 将a保存在行规程, 回车键继续发送至行规程, 才会去唤醒应用程序, scanf被唤醒得到了a, 把a发给另一个串口, 串口1开始接收(一位一位), 所以write发送了,但是read没有接受, 返回0, 第二个字符时enter, 又没有读到数据,  输入字符b, read读到a(行规程里第一个数据)</p>
<p>主要问题是write确实可以发送出去, 但是串口没有得到数据呢(没有上报给驱动程序), read返回0, 所以要设置读到最小字节为1, 没有数据的话永远等待(等待时间设置)</p>
<h2 id="i2c"><a class="markdownIt-Anchor" href="#i2c"></a> I2C</h2>
<h3 id="i2c框架"><a class="markdownIt-Anchor" href="#i2c框架"></a> I2C框架</h3>
<img src="https://pic.imgdb.cn/item/62892229094754312979a1b0.jpg" style="zoom: 80%;">
<p>一个芯片里面有一个或者多个I2C控制器, 一个I2C控制器上面可以挂载一个或者多个I2C设备, 访问这些设备需要去寻址, 所以使用I2C总线来操作设备时, 首先得知道设备的设备地址, 知道后就可以跟他收发数据了.</p>
<p>I2C总线只需要2条线：时钟线SCL、数据线SDA.  在I2C总线的SCL、SDA线上，都有上拉电阻</p>
<img src="https://pic.imgdb.cn/item/6289231a09475431297a306e.jpg" style="zoom: 50%;">
<p>APP(open/read/write)  设备驱动程序(例如EEPROM存储设备  TS触摸屏设备)  控制驱动程序</p>
<h3 id="协议"><a class="markdownIt-Anchor" href="#协议"></a> 协议</h3>
<p>控芯片引出两条线SCL(SCK),SDA线，在一条I2C总线上可以接很多I2C设备，我们还会放一个上拉电阻</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">简单的例子，来解释一下IIC的传输协议：</span><br><span class="line">    老师说开始了，表示开始信号(start)</span><br><span class="line">    老师提醒某个学生要发球，表示发送地址和方向(address/read/write)</span><br><span class="line">    老师发球/接球，表示数据的传输</span><br><span class="line">    收到球要回应：回应信号(ACK)</span><br><span class="line">    老师说结束，表示IIC传输结束(P)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="写操作"><a class="markdownIt-Anchor" href="#写操作"></a> 写操作</h4>
<p>主芯片要发出一个start信号</p>
<p>然后发出一个设备地址(用来确定是往哪一个芯片写数据)，方向(读/写，0表示写，1表示读)</p>
<p>从设备回应(用来确定这个设备是否存在)，然后就可以传输数据</p>
<p>主设备发送一个字节数据给从设备，并等待回应</p>
<p>每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成)，然后再传输下一个数据。</p>
<p>数据发送完之后，主芯片就会发送一个停止信号。</p>
<p>下图：白色背景表示"主→从"，灰色背景表示"从→主"</p>
<img src="https://pic.imgdb.cn/item/6289251a09475431297b5a97.jpg" style="zoom: 67%;">
<h4 id="读操作"><a class="markdownIt-Anchor" href="#读操作"></a> 读操作</h4>
<p>主芯片要发出一个start信号</p>
<p>然后发出一个设备地址(用来确定是往哪一个芯片写数据)，方向(读/写，0表示写，1表示读)</p>
<p>从设备回应(用来确定这个设备是否存在)，然后就可以传输数据</p>
<p>从设备发送一个字节数据给主设备，并等待回应</p>
<p>每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成)，然后再传输下一个数据。</p>
<p>数据发送完之后，主芯片就会发送一个停止信号。</p>
<p>下图：白色背景表示"主→从"，灰色背景表示"从→主"</p>
<img src="https://pic.imgdb.cn/item/628925a609475431297baade.jpg" style="zoom:73%;">
<h4 id="信号"><a class="markdownIt-Anchor" href="#信号"></a> 信号</h4>
<p>I2C协议中数据传输的单位是字节，也就是8位。但是要用到9个时钟：前面8个时钟用来传输8数据，第9个时钟用来传输回应信号。传输时，先传输最高位(MSB)。</p>
<p>开始信号（S）：SCL为高电平时，SDA山高电平向低电平跳变，开始传送数据。</p>
<p>结束信号（P）：SCL为高电平时，SDA由低电平向高电平跳变，结束传送数据。</p>
<p>响应信号(ACK)：接收器在接收到8位数据后，在第9个时钟周期，拉低SDA</p>
<p><strong>SDA上传输的数据必须在SCL为高电平期间保持稳定，SDA上的数据只能在SCL为低电平期间变化</strong></p>
<img src="https://pic.imgdb.cn/item/6289261409475431297be5f7.jpg" style="zoom:110%;">
<h4 id="细节"><a class="markdownIt-Anchor" href="#细节"></a> 细节</h4>
<p>如何在SDA上实现双向传输？<br>
主芯片通过一根SDA线既可以把数据发给从设备，也可以从SDA上读取数据，连接SDA线的引脚里面必然有两个引脚（发送引   	脚/接受引脚）。</p>
<p>主、从设备都可以通过SDA发送数据，肯定不能同时发送数据，怎么错开时间？<br>
在9个时钟里，<br>
前8个时钟由主设备发送数据的话，第9个时钟就由从设备发送数据；<br>
前8个时钟由从设备发送数据的话，第9个时钟就由主设备发送数据。</p>
<p>双方设备中，某个设备发送数据时，另一方怎样才能不影响SDA上的数据？<br>
设备的SDA中有一个三极管，使用开极/开漏电路(三极管是开极，CMOS管是开漏，作用一样)，如下图：</p>
<img src="https://pic.imgdb.cn/item/6289ef530947543129f9709c.jpg" style="zoom:50%;">
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当某一个芯片不想影响SDA线时，那就不驱动这个三极管</span><br><span class="line">想让SDA输出高电平，双方都不驱动三极管(SDA通过上拉电阻变为高电平)</span><br><span class="line">想让SDA输出低电平，就驱动三极管</span><br></pre></td></tr></tbody></table></figure>
<p><strong>举例</strong>(双向传输)     主设备发送（8bit）给从设备</p>
<ul>
<li>
<p>前8个clk</p>
<p>从设备不要影响SDA，从设备不驱动三极管</p>
<p>主设备决定数据，主设备要发送1时不驱动三极管，要发送0时驱动三极管</p>
</li>
<li>
<p>第9个clk，由从设备决定数据</p>
<p>主设备不驱动三极管</p>
<p>从设备决定数据，要发出回应信号的话，就驱动三极管让SDA变为0</p>
<p>从这里也可以知道ACK信号是低电平</p>
</li>
</ul>
<p><code>从上面的例子，就可以知道怎样在一条线上实现双向传输，这就是SDA上要使用上拉电阻的原因。</code></p>
<p>为何SCL也要使用上拉电阻？<br>
在第9个时钟之后，如果有某一方需要更多的时间来处理数据，它可以一直驱动三极管把SCL拉低。<br>
当SCL为低电平时候，大家都不应该使用IIC总线，只有当SCL从低电平变为高电平的时候，IIC总线才能被使用。<br>
当它就绪后，就可以不再驱动三极管，这是上拉电阻把SCL变为高电平，其他设备就可以继续使用I2C总线了。</p>
<p>对于IIC协议它只能规定怎么传输数据，数据是什么含义由从设备决定。</p>
<h3 id="smbus协议"><a class="markdownIt-Anchor" href="#smbus协议"></a> SMBus协议</h3>
<p>SMBus: System Management Bus，系统管理总线。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SMBus最初的目的是为智能电池、充电电池、其他微控制器之间的通信链路而定义的。</span><br><span class="line">SMBus也被用来连接各种设备，包括电源相关设备，系统传感器，EEPROM通讯设备等等。</span><br><span class="line">SMBus 为系统和电源管理这样的任务提供了一条控制总线，使用 SMBus 的系统，设备之间发送和接收消息都是通过 SMBus，而不是使用单独的控制线，这样可以节省设备的管脚数。</span><br><span class="line">SMBus是基于I2C协议的，SMBus要求更严格，SMBus是I2C协议的子集。</span><br></pre></td></tr></tbody></table></figure>
<p>跟一般的I2C协议的差别</p>
<p>	VDD的极限值不一样<br>
I2C协议：范围很广，甚至讨论了高达12V的情况<br>
SMBus：1.8V~5V<br>
	最小时钟频率、最大的Clock Stretching<br>
Clock Stretching含义：某个设备需要更多时间进行内部的处理时，它可以把SCL拉低占住I2C总线<br>
I2C协议：时钟频率最小值无限制，Clock Stretching时长也没有限制<br>
SMBus：时钟频率最小值是10KHz，Clock Stretching的最大时间值也有限制<br>
	地址回应(Address Acknowledge)<br>
一个I2C设备接收到它的设备地址后，是否必须发出回应信号？<br>
I2C协议：没有强制要求必须发出回应信号<br>
SMBus：强制要求必须发出回应信号，这样对方才知道该设备的状态：busy，failed，或是被移除了</p>
<p>	REPEATED START Condition(重复发出S信号)<br>
比如读EEPROM时，涉及2个操作：<br>
把存储地址发给设备  and   读数据<br>
在写、读之间，可以不发出P信号，而是直接发出S信号：这个S信号就是REPEATED START<br>
<img src="https://pic.imgdb.cn/item/6289f3850947543129fc638d.jpg" style="zoom: 80%;"></p>
<p>	SMBus协议明确了数据的传输格式<br>
I2C协议：它只定义了怎么传输数据，但是并没有定义数据的格式，这完全由设备来定义<br>
SMBus：定义了几种数据格式(下面分析)</p>
<p>I2C Block Write 和 I2C SMBus Block Write 的区别L: 传输过程会不会传输Byte Count值</p>
<h3 id="i2c系统重要结构体"><a class="markdownIt-Anchor" href="#i2c系统重要结构体"></a> I2C系统重要结构体</h3>
<p>使用一句话概括I2C传输：APP通过I2C Controller与I2C Device传输数据。</p>
<p>在Linux中：</p>
<ul>
<li>
<p>怎么表示I2C Controller</p>
<ul>
<li>
<p>一个芯片里可能有多个I2C Controller，比如第0个、第1个、……</p>
</li>
<li>
<p>对于使用者，只要确定是第几个I2C Controller即可</p>
</li>
<li>
<p>使用i2c_adapter表示一个I2C BUS，或称为I2C Controller(使用面向对象的方式)</p>
</li>
<li>
<p>里面有2个重要的成员：</p>
<ul>
<li>nr：第几个I2C BUS(I2C Controller)</li>
<li>i2c_algorithm，里面有该I2C BUS的传输函数，用来收发I2C数据</li>
</ul>
</li>
<li>
<p>i2c_adapter</p>
<img src="https://pic.imgdb.cn/item/6289fbe1094754312901f9f4.jpg" style="zoom:80%;">
</li>
<li>
<p>i2c_algorithm</p>
</li>
</ul>
</li>
</ul>
<img src="https://pic.imgdb.cn/item/6289fd22094754312902b564.jpg" style="zoom:80%;">
<ul>
<li>
<p>怎么表示I2C Device</p>
<ul>
<li>
<p>一个I2C Device，一定有<strong>设备地址</strong></p>
</li>
<li>
<p>它连接在哪个I2C Controller上，即对应的i2c_adapter是什么</p>
</li>
<li>
<p>使用i2c_client来表示一个I2C Device</p>
</li>
</ul>
<img src="https://pic.imgdb.cn/item/6289fd34094754312902c30f.jpg" style="zoom:80%;">
</li>
<li>
<p>怎么表示要传输的数据</p>
<ul>
<li>
<p>在上面的i2c_algorithm结构体中可以看到要传输的数据被称为：i2c_msg</p>
</li>
<li>
<p>i2c_msg</p>
<img src="https://pic.imgdb.cn/item/6289fd4d094754312902d1e2.jpg" style="zoom:90%;">
</li>
<li>
<p>i2c_msg中的flags用来表示传输方向：bit 0等于I2C_M_RD表示读，bit 0等于0表示写</p>
</li>
<li>
<p>一个i2c_msg要么是读，要么是写</p>
</li>
<li>
<p>举例：设备地址为0x50的EEPROM，要读取它里面存储地址为0x10的一个字节，应该构造几个i2c_msg？</p>
<ul>
<li>
<p>要构造2个i2c_msg</p>
</li>
<li>
<p>第一个i2c_msg表示写操作，把要访问的存储地址0x10发给设备</p>
</li>
<li>
<p>第二个i2c_msg表示读操作</p>
</li>
<li>
<p>代码如下</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">u8 data_addr = <span class="number">0x10</span>; </span><br><span class="line">i8 data; </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msgs</span>[2];</span> </span><br><span class="line"></span><br><span class="line">msgs[<span class="number">0</span>].addr = <span class="number">0x50</span>; </span><br><span class="line">msgs[<span class="number">0</span>].flags = <span class="number">0</span>; </span><br><span class="line">msgs[<span class="number">0</span>].len = <span class="number">1</span>; </span><br><span class="line">msgs[<span class="number">0</span>].buf = &amp;data_addr; </span><br><span class="line"></span><br><span class="line">msgs[<span class="number">1</span>].addr = <span class="number">0x50</span>; </span><br><span class="line">msgs[<span class="number">1</span>].flags = I2C_M_RD; </span><br><span class="line">msgs[<span class="number">1</span>].len = <span class="number">1</span>; </span><br><span class="line">msgs[<span class="number">1</span>].buf = &amp;data;</span><br></pre></td></tr></tbody></table></figure>
<p><strong>内核怎么传输数据</strong> 使用一句话概括I2C传输：</p>
<ul>
<li>
<p>APP通过I2C Controller与I2C Device传输数据</p>
</li>
<li>
<p>APP通过i2c_adapter与i2c_client传输i2c_msg</p>
</li>
<li>
<p>内核函数i2c_transfer</p>
<ul>
<li>
<p>i2c_msg里含有addr，所以这个函数里不需要i2c_client</p>
<p><code>int i2c_transfer(struct i2c_adapter *adap, struct i2c_msg *msgs, int num)</code></p>
</li>
</ul>
</li>
</ul>
<h3 id="无需编写驱动直接访问设备_i2c-tools介绍"><a class="markdownIt-Anchor" href="#无需编写驱动直接访问设备_i2c-tools介绍"></a> 无需编写驱动直接访问设备_I2C-Tools介绍</h3>
<p>APP访问硬件肯定是需要驱动程序的，对于I2C设备，内核提供了驱动程序 drivers/i2c/i2c-dev.c ，通过它可以直接使用下面的I2C控制器 驱动程序来访问I2C设备</p>
<img src="https://pic.imgdb.cn/item/628a08bb09475431290a532b.jpg" style="zoom: 67%;">
<p>使用一句话概括I2C传输：APP通过I2C Controller与I2C Device传输数据。</p>
<p>所以使用I2C-Tools时也需要指定：</p>
<ul>
<li>
<p>哪个I2C控制器(或称为I2C BUS、I2C Adapter)</p>
</li>
<li>
<p>哪个I2C设备(设备地址)</p>
</li>
<li>
<p>数据：读还是写、数据本身</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">AP3216C是红外、光强、距离三合一的传感器，以读出光强、距离值为例，步骤如下：</span><br><span class="line">复位：往寄存器0写入0x4</span><br><span class="line">使能：往寄存器0写入0x3</span><br><span class="line">读光强：读寄存器0xC、0xD得到2字节的光强</span><br><span class="line">读距离：读寄存器0xE、0xF得到2字节的距离值</span><br><span class="line">AP3216C的设备地址是0x1E，假设节在I2C BUS0上，操作命令如下：</span><br><span class="line">i2cdetect </span><br><span class="line">查看当前i2c设备</span><br><span class="line">用法: i2cdetect 0 或者 i2cdetect -l</span><br><span class="line">使用SMBus协议</span><br><span class="line">i2cset -f -y 0 0x1e 0 0x4 </span><br><span class="line">i2cset -f -y 0 0x1e 0 0x3 </span><br><span class="line">i2cget -f -y 0 0x1e 0xc w </span><br><span class="line">i2cget -f -y 0 0x1e 0xe w </span><br><span class="line">使用I2C协议</span><br><span class="line">i2ctransfer -f -y 0 w2@0x1e 0 0x4 </span><br><span class="line">i2ctransfer -f -y 0 w2@0x1e 0 0x3 </span><br><span class="line">i2ctransfer -f -y 0 w1@0x1e 0xc r2 </span><br><span class="line">i2ctransfer -f -y 0 w1@0x1e 0xe r2</span><br></pre></td></tr></tbody></table></figure>
<h4 id="访问i2c设备的俩种方式"><a class="markdownIt-Anchor" href="#访问i2c设备的俩种方式"></a> 访问I2C设备的俩种方式</h4>
<p>I2C-Tools可以通过SMBus来访问I2C设备，也可以使用一般的I2C协议来访问I2C设备。</p>
<p>使用一句话概括I2C传输：APP通过I2C Controller与I2C Device传输数据。</p>
<p>在APP里，有这几个问题：</p>
<ul>
<li>
<p>怎么指定I2C控制器？</p>
<ul>
<li>
<p>i2c-dev.c提供为每个I2C控制器(I2C Bus、I2C Adapter)都生成一个设备节点：/dev/i2c-0、/dev/i2c-1等待</p>
</li>
<li>
<p>open某个/dev/i2c-X节点，就是去访问该I2C控制器下的设备</p>
</li>
</ul>
</li>
<li>
<p>怎么指定I2C设备？</p>
<ul>
<li>
<p>通过ioctl指定I2C设备的地址</p>
</li>
<li>
<p>ioctl(fifile, I2C_SLAVE, address)</p>
<ul>
<li>如果该设备已经有了对应的设备驱动程序，则返回失败</li>
</ul>
</li>
<li>
<p>ioctl(fifile, I2C_SLAVE_FORCE, address)</p>
<ul>
<li>
<p>如果该设备已经有了对应的设备驱动程序</p>
</li>
<li>
<p>但是还是想通过i2c-dev驱动来访问它</p>
</li>
<li>
<p>则使用这个ioctl来指定I2C设备地址</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>怎么传输数据？</p>
<ul>
<li>
<p>两种方式</p>
</li>
<li>
<p>一般的I2C方式：ioctl(fifile, I2C_RDWR, &amp;rdwr)</p>
</li>
<li>
<p>SMBus方式：ioctl(fifile, I2C_SMBUS, &amp;args)</p>
</li>
</ul>
</li>
</ul>
<h4 id="源码"><a class="markdownIt-Anchor" href="#源码"></a> 源码</h4>
<p>i2c方式</p>
<img src="https://pic.imgdb.cn/item/628a1fec09475431291adf28.jpg" style="zoom: 67%;">
<p>SMBus方式</p>
<img src="https://pic.imgdb.cn/item/628a201109475431291af879.jpg" style="zoom:67%;">
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c-dev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;i2c/smbus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"i2cbusses.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ./at24c02 &lt;i2c_bus_number&gt; w "100ask.taobao.com"</span></span><br><span class="line"><span class="comment"> * ./at24c02 &lt;i2c_bus_number&gt; r</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> dev_addr = <span class="number">0x50</span>;<span class="comment">//设备地址</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> mem_addr = <span class="number">0</span>;<span class="comment">//存储空间地址</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> file;</span><br><span class="line">    <span class="type">char</span> filename[<span class="number">20</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *str;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">req</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span> &amp;&amp; argc != <span class="number">4</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage:\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"write eeprom: %s &lt;i2c_bus_number&gt; w string\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"read  eeprom: %s &lt;i2c_bus_number&gt; r\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    file = open_i2c_dev(argv[<span class="number">1</span>][<span class="number">0</span>]-<span class="string">'0'</span>, filename, <span class="keyword">sizeof</span>(filename), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (file &lt; <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't open %s\n"</span>, filename);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (set_slave_addr(file, dev_addr, <span class="number">1</span>))</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't set_slave_addr\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">2</span>][<span class="number">0</span>] == <span class="string">'w'</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// write str: argv[3]</span></span><br><span class="line">        str = argv[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        req.tv_sec  = <span class="number">0</span>;</span><br><span class="line">        req.tv_nsec = <span class="number">20000000</span>; <span class="comment">/* 20ms */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (*str)</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// mem_addr, *str</span></span><br><span class="line">            <span class="comment">// mem_addr++, str++</span></span><br><span class="line">            ret = i2c_smbus_write_byte_data(file, mem_addr, *str);</span><br><span class="line">            <span class="keyword">if</span> (ret)</span><br><span class="line">            {</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"i2c_smbus_write_byte_data err\n"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// wait tWR(10ms)</span></span><br><span class="line">            nanosleep(&amp;req, <span class="literal">NULL</span>);</span><br><span class="line">            </span><br><span class="line">            mem_addr++;</span><br><span class="line">            str++;</span><br><span class="line">        }</span><br><span class="line">        ret = i2c_smbus_write_byte_data(file, mem_addr, <span class="number">0</span>); <span class="comment">// string end char</span></span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"i2c_smbus_write_byte_data err\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// read</span></span><br><span class="line">        ret = i2c_smbus_read_i2c_block_data(file, mem_addr, <span class="keyword">sizeof</span>(buf), buf);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"i2c_smbus_read_i2c_block_data err\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        buf[<span class="number">31</span>] = <span class="string">'\0'</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"get data: %s\n"</span>, buf);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>嵌入式基础</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://blogs.leechee.top/posts/5c8c37e6/">https://blogs.leechee.top/posts/5c8c37e6/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display: inline-block;width: 120px"><h>作者</h><div class="post-copyright-cc-info"><h>Leechee</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2022-02-01</h></div></div><div class="post-copyright-u" style="display: inline-block;width: 120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-04-11</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 180px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener external nofollow noreferrer" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener external nofollow noreferrer" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C-C/">C/C++</a><a class="post-meta__tags" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a><a class="post-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imgdb.cn/item/63c0cf0fbe43e0d30e6bb230.webp" data-sites="qq,wechat,weibo"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/6c0c8dda/"><img class="prev-cover" src="https://pic.imgdb.cn/item/63bf9804be43e0d30e7d1cc9.webp" onerror="onerror=null;src='https://pic.imgdb.cn/item/63e4af9a4757feff33314fe5.webp'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">日常效率Tips</div></div></a></div><div class="next-post pull-right"><a href="/posts/fd31ca55/"><img class="next-cover" src="https://pic.imgdb.cn/item/63e4af9a4757feff33315007.webp" onerror="onerror=null;src='https://pic.imgdb.cn/item/63e4af9a4757feff33314fe5.webp'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">C++基础再学习</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/6c0c8dda/" title="日常效率Tips"><img class="cover" src="https://pic.imgdb.cn/item/63bf9804be43e0d30e7d1cc9.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-01-13</div><div class="title">日常效率Tips</div></div></a></div><div><a href="/posts/f9a964a9/" title="C++"><img class="cover" src="https://pic.imgdb.cn/item/63e4afe94757feff3331edc8.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-01-11</div><div class="title">C++</div></div></a></div><div><a href="/posts/fd31ca55/" title="C++基础再学习"><img class="cover" src="https://pic.imgdb.cn/item/63e4af9a4757feff33315007.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-01-11</div><div class="title">C++基础再学习</div></div></a></div><div><a href="/posts/9454662e/" title="QT"><img class="cover" src="https://pic.imgdb.cn/item/63e4af9a4757feff33315062.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-01-11</div><div class="title">QT</div></div></a></div><div><a href="/posts/9c7668f5/" title="ubuntu20的vscode设置"><img class="cover" src="https://pic.imgdb.cn/item/63e4af9a4757feff33315007.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-04-11</div><div class="title">ubuntu20的vscode设置</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="fgx"><div class="avatar_img"><img style="border-radius:10px" src="/img/a.webp" onerror="this.onerror=null;this.src='https://pic.imgdb.cn/item/63e4af9a4757feff33314fe5.webp'" alt="avatar"></div><div class="author-info__description"></div><div class="rights"><div class="author-info__name">Leechee</div><div class="card-info-data site-data is-center"><a class="adiv" href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a class="adiv" href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a class="adiv" href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/llechee" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://blog.csdn.net/" rel="external nofollow noreferrer" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://www.cnblogs.com/LYXOal" rel="external nofollow noreferrer" target="_blank" title="博客园"><i class="iconfont icon-RSS"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本网站的Twikoo评论系统使用Cravatar头像系统，请自行绑定邮箱配置</div></div><div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden;"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%;"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text"> 操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C"><span class="toc-number">1.1.</span> <span class="toc-text"> 网络</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.</span> <span class="toc-text"> 一些命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">2.</span> <span class="toc-text"> 入门</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#linux"><span class="toc-number">3.</span> <span class="toc-text"> Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#gcc"><span class="toc-number">3.1.</span> <span class="toc-text"> GCC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#makefile"><span class="toc-number">3.2.</span> <span class="toc-text"> Makefile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8makefile%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 通用Makefile使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6io"><span class="toc-number">3.3.</span> <span class="toc-text"> 文件IO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E6%80%8E%E4%B9%88%E8%BF%9B%E5%85%A5%E5%86%85%E6%A0%B8"><span class="toc-number">3.3.1.</span> <span class="toc-text"> 系统调用函数怎么进入内核?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#linux%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="toc-number">4.</span> <span class="toc-text"> Linux软件架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#linux%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text"> Linux启动过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3bootloader%E4%B8%8Ekernel"><span class="toc-number">4.2.</span> <span class="toc-text"> 如何理解Bootloader与Kernel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">4.3.</span> <span class="toc-text"> 文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">4.3.1.</span> <span class="toc-text"> 概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">4.3.2.</span> <span class="toc-text"> 虚拟文件系统、根文件系统和文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vfs"><span class="toc-number">4.3.3.</span> <span class="toc-text"> VFS：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">4.3.4.</span> <span class="toc-text"> 根文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">4.3.5.</span> <span class="toc-text"> 其他文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uboot%E4%B8%8E%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">4.3.6.</span> <span class="toc-text"> uboot与根文件系统的关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E7%BC%96%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text"> 应用编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#framebufferioctl-mmap"><span class="toc-number">5.1.</span> <span class="toc-text"> Framebuffer(ioctl  mmap)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ioctl"><span class="toc-number">5.1.1.</span> <span class="toc-text"> ioctl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmap"><span class="toc-number">5.1.2.</span> <span class="toc-text"> mmap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E5%AD%97%E6%98%BE%E7%A4%BA"><span class="toc-number">5.2.</span> <span class="toc-text"> 文字显示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81"><span class="toc-number">5.2.1.</span> <span class="toc-text"> 字符编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ascii%E5%AD%97%E7%AC%A6%E6%98%BE%E7%A4%BA"><span class="toc-number">5.2.2.</span> <span class="toc-text"> ASCII字符显示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E5%AD%97%E7%AC%A6%E6%98%BE%E7%A4%BA"><span class="toc-number">5.2.3.</span> <span class="toc-text"> 中文字符显示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%A8%8B%E5%BA%8F%E4%BB%A5freetype%E4%B8%BA%E4%BE%8B"><span class="toc-number">5.2.4.</span> <span class="toc-text"> 交叉编译程序：以freetype为例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%93%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-number">5.2.4.1.</span> <span class="toc-text"> 库相关知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91"><span class="toc-number">5.2.4.2.</span> <span class="toc-text"> 交叉编译</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#freetype"><span class="toc-number">5.2.5.</span> <span class="toc-text"> freetype</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F"><span class="toc-number">5.3.</span> <span class="toc-text"> 输入系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6"><span class="toc-number">5.3.1.</span> <span class="toc-text"> 框架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="toc-number">5.3.1.1.</span> <span class="toc-text"> 调试技巧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E7%94%A8%E5%BA%93%E5%BC%80%E5%8F%91%E5%BA%94%E7%94%A8"><span class="toc-number">5.3.1.2.</span> <span class="toc-text"> 不用库开发应用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="toc-number">5.3.1.2.1.</span> <span class="toc-text"> 查询方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%91%E7%9C%A0-%E5%94%A4%E9%86%92%E6%96%B9%E5%BC%8F"><span class="toc-number">5.3.1.2.2.</span> <span class="toc-text"> 休眠-唤醒方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pollselect%E6%96%B9%E5%BC%8F"><span class="toc-number">5.3.1.2.3.</span> <span class="toc-text"> POLL/SELECT方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">5.3.1.3.</span> <span class="toc-text"> 异步通知方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tslib"><span class="toc-number">5.3.2.</span> <span class="toc-text"> tslib</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1"><span class="toc-number">5.4.</span> <span class="toc-text"> 网络通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">5.5.</span> <span class="toc-text"> 多线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3"><span class="toc-number">5.6.</span> <span class="toc-text"> 串口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tty%E4%BD%93%E7%B3%BB%E4%B8%AD%E8%AE%BE%E5%A4%87%E8%8A%82%E7%82%B9%E7%9A%84%E5%B7%AE%E5%88%AB"><span class="toc-number">5.6.1.</span> <span class="toc-text"> TTY体系中设备节点的差别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tty%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="toc-number">5.6.2.</span> <span class="toc-text"> TTY驱动框架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%8C%E8%A7%84%E7%A8%8B"><span class="toc-number">5.6.2.1.</span> <span class="toc-text"> 行规程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%B8%B2%E5%8F%A3%E5%BA%94%E7%94%A8%E7%BC%96%E7%A8%8B"><span class="toc-number">5.6.3.</span> <span class="toc-text"> Linux串口应用编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E6%80%8E%E4%B9%88%E6%8F%92"><span class="toc-number">5.6.3.1.</span> <span class="toc-text"> 串口怎么插</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3api"><span class="toc-number">5.6.3.2.</span> <span class="toc-text"> 串口API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%9B%9E%E7%8E%AF"><span class="toc-number">5.6.3.3.</span> <span class="toc-text"> 实例(回环)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#i2c"><span class="toc-number">5.7.</span> <span class="toc-text"> I2C</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#i2c%E6%A1%86%E6%9E%B6"><span class="toc-number">5.7.1.</span> <span class="toc-text"> I2C框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE"><span class="toc-number">5.7.2.</span> <span class="toc-text"> 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">5.7.2.1.</span> <span class="toc-text"> 写操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E6%93%8D%E4%BD%9C"><span class="toc-number">5.7.2.2.</span> <span class="toc-text"> 读操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7"><span class="toc-number">5.7.2.3.</span> <span class="toc-text"> 信号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%86%E8%8A%82"><span class="toc-number">5.7.2.4.</span> <span class="toc-text"> 细节</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smbus%E5%8D%8F%E8%AE%AE"><span class="toc-number">5.7.3.</span> <span class="toc-text"> SMBus协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#i2c%E7%B3%BB%E7%BB%9F%E9%87%8D%E8%A6%81%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">5.7.4.</span> <span class="toc-text"> I2C系统重要结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%9C%80%E7%BC%96%E5%86%99%E9%A9%B1%E5%8A%A8%E7%9B%B4%E6%8E%A5%E8%AE%BF%E9%97%AE%E8%AE%BE%E5%A4%87_i2c-tools%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.7.5.</span> <span class="toc-text"> 无需编写驱动直接访问设备_I2C-Tools介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEi2c%E8%AE%BE%E5%A4%87%E7%9A%84%E4%BF%A9%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">5.7.5.1.</span> <span class="toc-text"> 访问I2C设备的俩种方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">5.7.5.2.</span> <span class="toc-text"> 源码</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/5c8c37e6/" title="嵌入式驱动入门"><img src="https://pic.imgdb.cn/item/63e4afe94757feff3331ed49.webp" onerror="this.onerror=null;this.src='https://pic.imgdb.cn/item/63e4af9a4757feff33314fe5.webp'" alt="嵌入式驱动入门"></a><div class="content"><a class="title" href="/posts/5c8c37e6/" title="嵌入式驱动入门">嵌入式驱动入门</a><time datetime="2022-05-05T15:21:13.000Z" title="发表于 2022-05-05 23:21:13">2022-05-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/9454662e/" title="QT"><img src="https://pic.imgdb.cn/item/63e4af9a4757feff33315062.webp" onerror="this.onerror=null;this.src='https://pic.imgdb.cn/item/63e4af9a4757feff33314fe5.webp'" alt="QT"></a><div class="content"><a class="title" href="/posts/9454662e/" title="QT">QT</a><time datetime="2022-04-06T15:21:13.000Z" title="发表于 2022-04-06 23:21:13">2022-04-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/30335c15/" title="Linux 网络编程基础"><img src="https://pic.imgdb.cn/item/63e4af9a4757feff33315062.webp" onerror="this.onerror=null;this.src='https://pic.imgdb.cn/item/63e4af9a4757feff33314fe5.webp'" alt="Linux 网络编程基础"></a><div class="content"><a class="title" href="/posts/30335c15/" title="Linux 网络编程基础">Linux 网络编程基础</a><time datetime="2022-04-01T15:21:13.000Z" title="发表于 2022-04-01 23:21:13">2022-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f9a964a9/" title="C++"><img src="https://pic.imgdb.cn/item/63e4afe94757feff3331edc8.webp" onerror="this.onerror=null;this.src='https://pic.imgdb.cn/item/63e4af9a4757feff33314fe5.webp'" alt="C++"></a><div class="content"><a class="title" href="/posts/f9a964a9/" title="C++">C++</a><time datetime="2022-03-16T15:21:13.000Z" title="发表于 2022-03-16 23:21:13">2022-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/fa1802cb/" title="算法基础"><img src="https://pic.imgdb.cn/item/63e4afe94757feff3331ed01.webp" onerror="this.onerror=null;this.src='https://pic.imgdb.cn/item/63e4af9a4757feff33314fe5.webp'" alt="算法基础"></a><div class="content"><a class="title" href="/posts/fa1802cb/" title="算法基础">算法基础</a><time datetime="2022-03-16T15:21:13.000Z" title="发表于 2022-03-16 23:21:13">2022-03-16</time></div></div></div></div><div class="card-widget card-weather" style="width:100%,height:270px"><div class="item-headline"><i class="fas fa-cloud-sun"></i><span>天气</span></div><div id="he-plugin-standard"></div><script>WIDGET = {
  "CONFIG": {
    "layout": "2",
    "width": 270,
    "height": 270,
    "background": "5",
    "dataColor": "000000",
    "key": "cbeb39d80cf84c5a9b30f3e8687dabb6"
  }
}</script><script src="https://widget.qweather.net/standard/static/js/he-standard-common.js?v=2.0"></script></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="social-icons"></div><div class="copyright">©2021 - 2023 By Leechee</div><div class="framework-info"></div><div class="footer_custom_text" id="footer_custom_text">这个小破站已运行{y}年{d}天{s}时{min}分{sec}秒</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><a id="switch_commentBarrage" href="javascript:switchCommentBarrage();" rel="external nofollow noreferrer" title="开关弹幕"><i class="iconfont icon-danmu"></i></a><a id="opensettings" href="javascript:toggleWinbox();" rel="external nofollow noreferrer" title="博客设置"><i class="fa fa-wrench"></i></a><button id="go-up" type="button" title="回到顶部" onclick="rmf.scrollToTop()"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();" rel="external nofollow noreferrer"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();" rel="external nofollow noreferrer"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();" rel="external nofollow noreferrer"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();" rel="external nofollow noreferrer"><i class="iconfont icon-baidu"></i><span>百度搜索</span></a><a class="rightMenu-item" href="javascript:rmf.searchinThisPage();" rel="external nofollow noreferrer"><i class="fas fa-search"></i><span>站内搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()" rel="external nofollow noreferrer"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.click()" rel="external nofollow noreferrer"><i class="fa fa-arrows-alt"></i><span>全屏显示</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();" rel="external nofollow noreferrer"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.translate();" rel="external nofollow noreferrer"><i class="iconfont icon-fanti"></i><span>繁简转换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();" rel="external nofollow noreferrer"><i class="fa fa-book"></i><span>阅读模式</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();" rel="external nofollow noreferrer"><i class="fas fa-cog"></i><span>博客设置</span></a><a class="rightMenu-item" href="javascript:fullScreen();" rel="external nofollow noreferrer"><i class="fas fa-expand"></i><span>进入全屏</span></a></div></div><div class="js-pjax" id="settingWindow"><span class="setting-title"> <span id="stt">控制面板</span><a id="close-console" onclick="toggleWinbox();">×</a></span><button id="backer" onclick="$('.asetting').hide();$('.settingx').show();$('#backer').hide()"><i class="fa fa-chevron-left"></i><span>返回</span></button><div class="settings"><div id="setting-buttons"><button class="settingx" onclick="$('#theme-settings').show();$('.settingx').hide();$('#backer').show();"><i class="fas fa-layer-group"></i><span>外观</span></button><button class="settingx" onclick="$('#font-settings').show();$('.settingx').hide();$('#backer').show();"><i class="fa fa-font"></i><span>字体</span></button><button class="settingx" onclick="$('#background-settings').show();$('.settingx').hide();$('#backer').show();"><i class="far fa-image"></i><span>背景</span></button><button class="settingx" onclick="$('#con-echarts').show();$('.settingx').hide();$('#backer').show();var evt = document.createEvent(&quot;HTMLEvents&quot;);evt.initEvent(&quot;resize&quot;, false, false);window.dispatchEvent(evt);"><i class="fas fa-chart-pie"></i><span>统计</span></button><button class="settingx" onclick="$('#con-abouts').show();$('.settingx').hide();$('#backer').show();"><i class="fa fa-cloud-download"></i><span>关于</span></button></div><div id="setting-hides"><div class="asetting" id="theme-settings"><h2 class="content-head">性能设置</h2><p></p><div class="content" style="display:flex"><input id="blur" type="checkbox" onclick="setBlur()"><div class="content-text">禁用模糊效果</div></div><div class="content" style="display:flex"><input id="fpson" type="checkbox" onclick="fpssw()" style="flex-shrink: 0"><div class="content-text"><span>开启帧率检测（</span><a href="javascript:window.location.reload()" rel="external nofollow noreferrer">刷新</a><span>后生效）</span></div></div><p></p><p></p><h2 class="content-head">主题设置</h2><div class="content" style="display:flex"><input id="hideAplayer" type="checkbox" onclick="toggleAplayer()"><div class="content-text">显示aplayer</div></div><div class="content" style="display:flex"><input id="hideSakura" type="checkbox" onclick="toggleSakuras()"><div class="content-text">落樱特效</div></div><div class="content" style="display:flex"><input id="autoTheme" type="checkbox" onclick="toggleAutoTheme()"><div class="content-text">明暗模式自动切换</div></div><div class="content" style="display:flex"><input id="autoColor" type="checkbox" onclick="autoColor()"><div class="content-text">自动主题色（跟随文章封面）</div></div>未完工<div class="content" style="display:flex"><input id="hideAplayer" type="checkbox" onclick="toggleNav()"><div class="content-text">固定导航栏</div></div>###<div class="content" style="display:flex"><button class="content-button" onclick="switchTheme()">切换主题</button></div><p></p><p></p><h3 class="content-head">主题色</h3><div class="content" id="themeColorSettings" style="display:flex"><input id="red" type="radio" name="colors" onclick="setColor('red')"><input id="orange" type="radio" name="colors" onclick="setColor('orange')"><input id="yellow" type="radio" name="colors" onclick="setColor('yellow')"><input id="green" type="radio" name="colors" onclick="setColor('green')"><input id="blue" type="radio" name="colors" onclick="setColor('blue')"><input id="heoblue" type="radio" name="colors" onclick="setColor('heoblue')"><input id="darkblue" type="radio" name="colors" onclick="setColor('darkblue')"><input id="purple" type="radio" name="colors" onclick="setColor('purple')"><input id="pink" type="radio" name="colors" onclick="setColor('pink')" checked="checked"><input id="black" type="radio" name="colors" onclick="setColor('black')"><input id="blackgray" type="radio" name="colors" onclick="setColor('blackgray')"></div><p></p></div><div class="asetting" id="font-settings"><h2 class="content-head">字体设置</h2><p id="swfs"><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:'ZhuZiAWan'!important;color:black" onclick="setFont('ZhuZiAWan')">筑紫A丸ゴシック</a><br><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:'HYTMR'!important;color:black" onclick="setFont('HYTMR')">汉仪唐美人</a><br><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:'HYPailou'!important;color:black" onclick="setFont('HYPailou')">汉仪新蒂牌楼</a><br><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:'FZXJLJ'!important;color:black" onclick="setFont('FZXJLJ')">方正金陵体</a><br><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:'FZXS'!important;color:black" onclick="setFont('FZXS')">方正像素体</a><br><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:'FZODZK'!important;color:black" onclick="setFont('FZODZK')">方正欧蝶正楷</a><br><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:'Source Serif'!important;color:black" onclick="setFont('Source Serif')">思源宋体</a><br><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:'Source Sans'!important;color:black" onclick="setFont('Source Sans')">思源黑体</a><br><a class="swf" href="javascript:;" rel="noopener external nofollow" style="font-family:-apple-system, IBM Plex Mono ,monosapce,'微软雅黑', sans-serif;" onclick="setFont('main')">系统默认</a><br></p></div><div class="asetting" id="background-settings"><h2 style="margin-left:10px">背景设置</h2><div></div><span>注意:切换背景功能仅在当前主题中生效，在Simple主题中无效</span><button class="content-button" onclick="localStorage.removeItem('blogbg');location.reload();"><i class="fa-solid fa-arrows-rotate"></i><span> 点我恢复默认背景</span></button><button class="content-button" onclick="switchTheme()">切换主题</button><h3>图片（手机）</h3><div class="bgbox"><a class="pimgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d6d4d539a5.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d6d4d539a5.webp)')"></a><a class="pimgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d6d4e15c9d.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d6d4e15c9d.webp)')"></a><a class="pimgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d6f22c03c6.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d6f22c03c6.webp)')"></a><a class="pimgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d6d56c83eb.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d6d56c83eb.webp)')"></a><a class="pimgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d6d50b439b.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d6d50b439b.webp)')"></a></div><h3>图片（电脑）</h3><div class="bgbox"><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d6d5574d0e.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d6d5574d0e.webp)')"></a><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d6d529adf9.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d6d529adf9.webp)')"></a><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d6d5159b31.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d6d5159b31.webp)')"></a><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d718bbeef6.webp)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d718bbeef6.webp)')"></a><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d72f237d19.jpg)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d72f237d19.jpg)')"></a><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d72f2032c8.jpg)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d72f2032c8.jpg)')"></a><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2021/12/01/7792ff0082ec4.jpg)" onclick="changeBg('url(https://bu.dusays.com/2021/12/01/7792ff0082ec4.jpg)')"></a><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d72ee6d4f3.png)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d72ee6d4f3.png)')"></a><a class="imgbox" href="javascript:;" rel="noopener external nofollow" style="background-image:url(https://bu.dusays.com/2022/08/30/630d72ed76532.jpg)" onclick="changeBg('url(https://bu.dusays.com/2022/08/30/630d72ed76532.jpg)')"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://bu.dusays.com/2022/09/17/6324aea549be6.webp)')"><img src="https://bu.dusays.com/2022/09/17/6324aea549be6.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://bu.dusays.com/2022/09/17/6324aec701a68.webp)')"><img src="https://bu.dusays.com/2022/09/17/6324aec701a68.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://bu.dusays.com/2022/09/17/6324aef4a5543.webp)')"><img src="https://bu.dusays.com/2022/09/17/6324aef4a5543.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://bu.dusays.com/2022/09/17/6324af3622884.webp)')"><img src="https://bu.dusays.com/2022/09/17/6324af3622884.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/5.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/5.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/6.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/6.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/7.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/7.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://bu.dusays.com/2022/12/08/6391b77ed767c.png)')"><img src="https://bu.dusays.com/2022/12/08/6391b77ed767c.png"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/9.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/9.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/10.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/10.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/11.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/11.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/12.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/12.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/13.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/13.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/14.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/14.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/15.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/15.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/16.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/16.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/17.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/17.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/18.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/18.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/19.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/19.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/20.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/20.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/21.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/21.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/22.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/22.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/23.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/23.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/24.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/24.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/25.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/25.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/26.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/26.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/27.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/27.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/28.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/28.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/29.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/29.webp"></a><a class="imgbox" href="javascript:;" rel="external nofollow noreferrer" onclick="changeBg('url(https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/30.webp)')"><img src="https://cdn.afdelivr.top/npm/saiodgm-api@1.0.1/randomimg-my/30.webp"></a></div><h3>渐变色</h3><div class="bgbox"><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(to right, #eecda3, #ef629f)" onclick="changeBg('linear-gradient(to right, #eecda3, #ef629f)')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(to right, #B7D31E, #42CE1E)" onclick="changeBg('linear-gradient(to right, #B7D31E, #42CE1E)')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(to right, #06DE86, #06A5DE)" onclick="changeBg('linear-gradient(to right, #06DE86, #06A5DE)')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(to right, #189BC4, #183DC4)" onclick="changeBg('linear-gradient(to right, #189BC4, #183DC4)')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(to right, #C018C4, #C41818)" onclick="changeBg('linear-gradient(to right, #C018C4, #C41818)')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(to right, #8B00BB, #030094)" onclick="changeBg('linear-gradient(to right, #8B00BB, #030094)')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(to right, #eecda3, #ef629f)" onclick="changeBg('linear-gradient(to right, #eecda3, #ef629f)')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(90deg, #ffd7e4 0%, #c8f1ff 100%)" onclick="changeBg('linear-gradient(90deg, #ffd7e4 0%, #c8f1ff 100%)')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: linear-gradient(45deg, #e5737b, #c6999e, #96b9c2, #00d6e8)" onclick="changeBg('linear-gradient(45deg, #e5737b, #c6999e, #96b9c2, #00d6e8)')"></a></div><h3>纯色</h3><div class="bgbox"><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: #7D9D9C" onclick="changeBg('#7D9D9C')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: #fff" onclick="changeBg('#fff')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: #49A6E9" onclick="changeBg('#49A6E9')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: #F7CEFF" onclick="changeBg('#F7CEFF')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: #FFFFCE" onclick="changeBg('#FFFFCE')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: #CFFFCE" onclick="changeBg('#CFFFCE')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: #17EFE9" onclick="changeBg('#17EFE9')"></a><a class="box" href="javascript:;" rel="noopener external nofollow" style="background: #9F17EF" onclick="changeBg('#9F17EF')"></a></div></div><div class="asetting" id="con-echarts"><h1>文章统计</h1><h2>监控</h2><iframe src="" width="100%" height="500px" frameborder="no"></iframe><h2>文章统计</h2><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><div id="posts-chart" data-start="2021-01" style="border-radius: 8px; height: 300px; padding: 10px;"></div>
  <script id="postsChart">
    var color = document.documentElement.getAttribute('data-theme') === 'light' ? '#4c4948' : 'rgba(255,255,255,0.7)'
    var postsChart = echarts.init(document.getElementById('posts-chart'), 'light');
    var postsOption = {
      title: {
        text: '文章发布统计图',
        x: 'center',
        textStyle: {
          color: color
        }
      },
      tooltip: {
        trigger: 'axis'
      },
      xAxis: {
        name: '日期',
        type: 'category',
        boundaryGap: false,
        nameTextStyle: {
          color: color
        },
        axisTick: {
          show: false
        },
        axisLabel: {
          show: true,
          color: color
        },
        axisLine: {
          show: true,
          lineStyle: {
            color: color
          }
        },
        data: ["2021-01","2021-02","2021-03","2021-04","2021-05","2021-06","2021-07","2021-08","2021-09","2021-10","2021-11","2021-12","2022-01","2022-02","2022-03","2022-04","2022-05","2022-06","2022-07","2022-08","2022-09","2022-10","2022-11","2022-12","2023-01","2023-02","2023-03","2023-04"]
      },
      yAxis: {
        name: '文章篇数',
        type: 'value',
        nameTextStyle: {
          color: color
        },
        splitLine: {
          show: false
        },
        axisTick: {
          show: false
        },
        axisLabel: {
          show: true,
          color: color
        },
        axisLine: {
          show: true,
          lineStyle: {
            color: color
          }
        }
      },
      series: [{
        name: '文章篇数',
        type: 'line',
        smooth: true,
        lineStyle: {
            width: 0
        },
        showSymbol: false,
        itemStyle: {
          opacity: 1,
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
            offset: 0,
            color: 'rgba(128, 255, 165)'
          },
          {
            offset: 1,
            color: 'rgba(1, 191, 236)'
          }])
        },
        areaStyle: {
          opacity: 1,
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
            offset: 0,
            color: 'rgba(128, 255, 165)'
          }, {
            offset: 1,
            color: 'rgba(1, 191, 236)'
          }])
        },
        data: [1,0,1,1,0,0,0,0,0,0,0,0,2,4,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
        markLine: {
          data: [{
            name: '平均值',
            type: 'average',
            label: {
              color: color
            }
          }]
        }
      }]
    };
    postsChart.setOption(postsOption);
    window.addEventListener('resize', () => { 
      postsChart.resize();
    });
    postsChart.on('click', 'series', (event) => {
      if (event.componentType === 'series') window.location.href = '/archives/' + event.name.replace('-', '/');
    });
  </script><div id="tags-chart" data-length="10" style="border-radius: 8px; height: 300px; padding: 10px;"></div>
  <script id="tagsChart">
    var color = document.documentElement.getAttribute('data-theme') === 'light' ? '#4c4948' : 'rgba(255,255,255,0.7)'
    var tagsChart = echarts.init(document.getElementById('tags-chart'), 'light');
    var tagsOption = {
      title: {
        text: 'Top 10 标签统计图',
        x: 'center',
        textStyle: {
          color: color
        }
      },
      tooltip: {},
      xAxis: {
        name: '标签',
        type: 'category',
        nameTextStyle: {
          color: color
        },
        axisTick: {
          show: false
        },
        axisLabel: {
          show: true,
          color: color,
          interval: 0
        },
        axisLine: {
          show: true,
          lineStyle: {
            color: color
          }
        },
        data: ["C/C++","嵌入式","记录","语言","Linux","项目","ubuntu","hexo","post","学习"]
      },
      yAxis: {
        name: '文章篇数',
        type: 'value',
        splitLine: {
          show: false
        },
        nameTextStyle: {
          color: color
        },
        axisTick: {
          show: false
        },
        axisLabel: {
          show: true,
          color: color
        },
        axisLine: {
          show: true,
          lineStyle: {
            color: color
          }
        }
      },
      series: [{
        name: '文章篇数',
        type: 'bar',
        data: [{"name":"C/C++","value":6,"path":"tags/C-C/"},{"name":"嵌入式","value":4,"path":"tags/嵌入式/"},{"name":"记录","value":4,"path":"tags/记录/"},{"name":"语言","value":2,"path":"tags/语言/"},{"name":"Linux","value":2,"path":"tags/Linux/"},{"name":"项目","value":2,"path":"tags/项目/"},{"name":"ubuntu","value":2,"path":"tags/ubuntu/"},{"name":"hexo","value":2,"path":"tags/hexo/"},{"name":"post","value":2,"path":"tags/post/"},{"name":"学习","value":2,"path":"tags/学习/"},{"name":"算法","value":1,"path":"tags/算法/"},{"name":"排序","value":1,"path":"tags/排序/"},{"name":"数据结构","value":1,"path":"tags/数据结构/"},{"name":"unbuntu","value":1,"path":"tags/unbuntu/"},{"name":"高并发","value":1,"path":"tags/高并发/"},{"name":"C++","value":1,"path":"tags/C/"},{"name":"Tips","value":1,"path":"tags/Tips/"},{"name":"Windows","value":1,"path":"tags/Windows/"},{"name":"QT","value":1,"path":"tags/QT/"},{"name":"操作系统","value":1,"path":"tags/操作系统/"},{"name":"ROS机器人","value":1,"path":"tags/ROS机器人/"},{"name":"Drivers","value":1,"path":"tags/Drivers/"},{"name":"心得","value":1,"path":"tags/心得/"}],
        itemStyle: {
          borderRadius: [5, 5, 0, 0],
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
            offset: 0,
            color: 'rgba(128, 255, 165)'
          },
          {
            offset: 1,
            color: 'rgba(1, 191, 236)'
          }])
        },
        emphasis: {
          itemStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
              offset: 0,
              color: 'rgba(128, 255, 195)'
            },
            {
              offset: 1,
              color: 'rgba(1, 211, 255)'
            }])
          }
        },
        markLine: {
          data: [{
            name: '平均值',
            type: 'average',
            label: {
              color: color
            }
          }]
        }
      }]
    };
    tagsChart.setOption(tagsOption);
    window.addEventListener('resize', () => { 
      tagsChart.resize();
    });
    tagsChart.on('click', 'series', (event) => {
      if(event.data.path) window.location.href = '/' + event.data.path;
    });
  </script><div id="categories-chart" data-parent="true" style="border-radius: 8px; height: 300px; padding: 10px;"></div>
  <script id="categoriesChart">
    var color = document.documentElement.getAttribute('data-theme') === 'light' ? '#4c4948' : 'rgba(255,255,255,0.7)'
    var categoriesChart = echarts.init(document.getElementById('categories-chart'), 'light');
    var categoryParentFlag = false
    var categoriesOption = {
      title: {
        text: '文章分类统计图',
        x: 'center',
        textStyle: {
          color: color
        }
      },
      legend: {
        top: 'bottom',
        data: ["Linux","嵌入式","C/C++","HexoPost","DataStructure","Tips","Project"],
        textStyle: {
          color: color
        }
      },
      tooltip: {
        trigger: 'item'
      },
      series: []
    };
    categoriesOption.series.push(
      categoryParentFlag ? 
      {
        nodeClick :false,
        name: '文章篇数',
        type: 'sunburst',
        radius: ['15%', '90%'],
        center: ['50%', '55%'],
        sort: 'desc',
        data: [{"name":"Linux","value":4,"path":"categories/Linux/","id":"clgbrinji000rcout4sjeg2ge","parentId":"0"},{"name":"嵌入式","value":3,"path":"categories/嵌入式/","id":"clgbrinjo0016couth8hjbd8p","parentId":"0"},{"name":"C/C++","value":2,"path":"categories/C-C/","id":"clgbrinj20004cout6y3m3fqy","parentId":"0"},{"name":"HexoPost","value":2,"path":"categories/HexoPost/","id":"clgbrinju001rcoutcedx7q3o","parentId":"0"},{"name":"DataStructure","value":1,"path":"categories/DataStructure/","id":"clgbrinj7000ccoutg3h8apu4","parentId":"0"},{"name":"Tips","value":1,"path":"categories/Tips/","id":"clgbrinjk000zcout9rkzaskl","parentId":"0"},{"name":"Project","value":1,"path":"categories/Project/","id":"clgbrinjx0026cout1y81h14y","parentId":"0"}],
        itemStyle: {
          borderColor: '#fff',
          borderWidth: 2,
          emphasis: {
            focus: 'ancestor',
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(255, 255, 255, 0.5)'
          }
        }
      }
      :
      {
        name: '文章篇数',
        type: 'pie',
        radius: [30, 80],
        roseType: 'area',
        label: {
          color: color,
          formatter: '{b} : {c} ({d}%)'
        },
        data: [{"name":"Linux","value":4,"path":"categories/Linux/","id":"clgbrinji000rcout4sjeg2ge","parentId":"0"},{"name":"嵌入式","value":3,"path":"categories/嵌入式/","id":"clgbrinjo0016couth8hjbd8p","parentId":"0"},{"name":"C/C++","value":2,"path":"categories/C-C/","id":"clgbrinj20004cout6y3m3fqy","parentId":"0"},{"name":"HexoPost","value":2,"path":"categories/HexoPost/","id":"clgbrinju001rcoutcedx7q3o","parentId":"0"},{"name":"DataStructure","value":1,"path":"categories/DataStructure/","id":"clgbrinj7000ccoutg3h8apu4","parentId":"0"},{"name":"Tips","value":1,"path":"categories/Tips/","id":"clgbrinjk000zcout9rkzaskl","parentId":"0"},{"name":"Project","value":1,"path":"categories/Project/","id":"clgbrinjx0026cout1y81h14y","parentId":"0"}],
        itemStyle: {
          emphasis: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(255, 255, 255, 0.5)'
          }
        }
      }
    )
    categoriesChart.setOption(categoriesOption);
    window.addEventListener('resize', () => { 
    categoriesChart.resize();
    })
    categoriesChart.on('click', 'series', (event) => {
      if(event.data.path) window.location.href = '/' + event.data.path;
    });
  </script><h2>访问统计显示不出来请刷新页面<script data-pjax="" id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JnlSnWLD7XChjrlx/quote.js?theme=0&amp;col=true&amp;f=12&amp;badge=icon_0&amp;icon=center"></script></h2></div><div class="asetting" id="con-abouts"><h1>关于</h1>Hexo-theme-butterfly<br>欢迎<a href="/messageboard">反馈！</a></div></div></div><div id="setting-sidesl"><button class="reSettings con-rightside" title="恢复默认设置"><i class="fa fa-repeat"></i></button><div id="setting-sides"><button class="con-rightside" title="繁简转换" id="con-translate" onclick="javascript:rmf.translate();"><i class="iconfont icon-fanti"></i></button><button class="con-rightside" title="昼夜切换" id="con-mode" onclick="rmf.switchDarkMode();"><i class="fa fa-adjust"></i></button><button class="con-rightside" title="阅读模式" id="con-reading" onclick="rmf.switchReadMode();"><i class="fa fa-book-open"></i></button><button class="con-rightside" title="单双栏切换" id="con-toggleaside" onclick="toggleAside();"><i class="fas fa-arrows-alt-h"></i></button><button class="con-rightside" title="左右栏切换" id="con-toggleleftaside" onclick="switchAside();"><i class="fas fa-binoculars"></i></button><button class="con-rightside" title="全屏" id="con-fullscreen" onclick="fullScreen();"><i class="fas fa-expand"></i></button></div></div></div><!-- hexo injector body_end start --><script data-pjax="">
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementsByClassName('swiper-div')[0];
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="background:url(https://pic.imgdb.cn/item/63bf9804be43e0d30e7d1cc9.webp);border-radius:12px;opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><div class="blog-slider__content"><span class="blog-slider__code">2022-01-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/6c0c8dda/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt="">日常效率Tips</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div></div></div><div class="blog-slider__item swiper-slide" style="background:url(https://pic.imgdb.cn/item/63c0cf0fbe43e0d30e6bb230.webp);border-radius:12px;opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><div class="blog-slider__content"><span class="blog-slider__code">2022-02-01</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/5c8c37e6/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt="">嵌入式基础</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div><div class="swiper-button-prev"></div><div class="swiper-button-next"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer="" src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/5.4.5/js/swiper.min.js"></script><script defer="" data-pjax="" src="https://npm.elemecdn.com/hexo-butterfly-swiper-lyx/lib/swiper_init.js"></script><script async="" src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --><div><script src="https://npm.elemecdn.com/vue@2.6.11"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://yourapi.example.com/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://yourapi.example.com/',
      region: '',
      urls: [window.location.pathname],
      includeReply: true
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.7/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><script>var gitcalendar = new Vue({
  el: '#gitcalendar',
  data: {
    simplemode: false,
    user: 'llechee',
    fixed: 'fixed',
    px: 'px',
    x: '',
    y: '',
    span1: '',
    span2: '',
    month: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
    monthchange: [],
    oneyearbeforeday: '',
    thisday: '',
    amonthago: '',
    aweekago: '',
    weekdatacore: 0,
    datacore: 0,
    total: 0,
    datadate: '',
    data: [],
    positionplusdata: [],
    firstweek: [],
    lastweek: [],
    beforeweek: [],
    thisweekdatacore: 0,
    mounthbeforeday: 0,
    mounthfirstindex: 0,
    crispedges: 'crispedges',
    thisdayindex: 0,
    amonthagoindex: 0,
    amonthagoweek: [],
    firstdate: [],
    first2date: [],
    montharrbefore: [],
    monthindex: 0,
    color: ['#ebedf0', '#f1f8ff', '#dbedff', '#c8e1ff', '#79b8ff', '#2188ff', '#0366d6', '#005cc5', '#044289', '#032f62', '#05264c']
  },
  methods: {
    selectStyle(data, event) {
      document.querySelector('.angle-wrapper').style.display = 'block'
      this.span1 = data.date;
      this.span2 = data.count;
      this.x = event.clientX - 100;
      this.y = event.clientY - 60
    },
    outStyle() {
      document.querySelector('.angle-wrapper').style.display = 'none'
    },
    thiscolor(x) {
      if (x === 0) {
        let i = parseInt(x / 2);
        return this.color[0]
      } else if (x < 2) {
        return this.color[1]
      } else if (x < 20) {
        let i = parseInt(x / 2);
        return this.color[i]
      } else {
        return this.color[9]
      }
    },
  }
});
var apiurl = 'gcapi.yisous.xyz' ? 'https://gcapi.yisous.xyz/api?' : 'https://githubapi.ryanchristian.dev/user/'
var githubapiurl = apiurl + gitcalendar.user;
//canvas绘图
function responsiveChart() {
  let c = document.getElementById("gitcanvas");
  if (c) {
    let cmessage = document.getElementById("gitmessage");
    let ctx = c.getContext("2d");
    c.width = document.getElementById("gitcalendarcanvasbox").offsetWidth;
    let linemaxwitdh = 0.96 * c.width / gitcalendar.data.length;
    c.height = 9 * linemaxwitdh;
    let lineminwitdh = 0.8 * linemaxwitdh;
    let setposition = {
      x: 0.02 * c.width,
      y: 0.025 * c.width
    };
    for (let week in gitcalendar.data) {
      weekdata = gitcalendar.data[week];
      for (let day in weekdata) {
        let dataitem = {
          date: "",
          count: "",
          x: 0,
          y: 0
        };
        gitcalendar.positionplusdata.push(dataitem);
        ctx.fillStyle = gitcalendar.thiscolor(weekdata[day].count);
        setposition.y = Math.round(setposition.y * 100) / 100;
        dataitem.date = weekdata[day].date;
        dataitem.count = weekdata[day].count;
        dataitem.x = setposition.x;
        dataitem.y = setposition.y;
        ctx.fillRect(setposition.x, setposition.y, lineminwitdh, lineminwitdh);
        setposition.y = setposition.y + linemaxwitdh
      };
      setposition.y = 0.025 * c.width;
      setposition.x = setposition.x + linemaxwitdh
    };
    ctx.font = "600  Arial";
    ctx.fillStyle = '#aaa';
    ctx.fillText("日", 0, 1.9 * linemaxwitdh);
    ctx.fillText("二", 0, 3.9 * linemaxwitdh);
    ctx.fillText("四", 0, 5.9 * linemaxwitdh);
    ctx.fillText("六", 0, 7.9 * linemaxwitdh);
    let monthindexlist = c.width / 24;
    for (let index in gitcalendar.monthchange) {
      ctx.fillText(gitcalendar.monthchange[index], monthindexlist, 0.7 * linemaxwitdh);
      monthindexlist = monthindexlist + c.width / 12
    };
    cmessage.onmousemove = function(event) {
      document.querySelector('.angle-wrapper').style.display = 'none'
    };
    c.onmousemove = function(event) {
      document.querySelector('.angle-wrapper').style.display = 'none'
      getMousePos(c, event);
    };

    function getMousePos(canvas, event) {
      var rect = canvas.getBoundingClientRect();
      var x = event.clientX - rect.left * (canvas.width / rect.width);
      var y = event.clientY - rect.top * (canvas.height / rect.height);
      //console.log("x:"+x+",y:"+y);
      for (let item of gitcalendar.positionplusdata) {
        let lenthx = x - item.x;
        let lenthy = y - item.y;
        //console.log(lenthx,lenthy);
        if (0 < lenthx && lenthx < lineminwitdh) {
          if (0 < lenthy && lenthy < lineminwitdh) {
            //console.log(item.date,item.count)
            document.querySelector('.angle-wrapper').style.display = 'block'
            gitcalendar.span1 = item.date;
            gitcalendar.span2 = item.count;
            gitcalendar.x = event.clientX - 100;
            gitcalendar.y = event.clientY - 60
          }
        }
        //if(0< x - item.x <lineminwitdh&&0< y - item.y <lineminwitdh){
        //console.log(item.count,item.date);
        //}
      }
    }
  }
}
//数据统计算法
function addlastmonth() {
  if (gitcalendar.thisdayindex === 0) {
    thisweekcore(52);
    thisweekcore(51);
    thisweekcore(50);
    thisweekcore(49);
    thisweekcore(48);
    gitcalendar.thisweekdatacore += gitcalendar.firstdate[6].count;
    gitcalendar.amonthago = gitcalendar.firstdate[6].date
  } else {
    thisweekcore(52);
    thisweekcore(51);
    thisweekcore(50);
    thisweekcore(49);
    thisweek2core();
    gitcalendar.amonthago = gitcalendar.first2date[gitcalendar.thisdayindex - 1].date
  }
};

function thisweek2core() {
  for (let i = gitcalendar.thisdayindex - 1; i < gitcalendar.first2date.length; i++) {
    gitcalendar.thisweekdatacore += gitcalendar.first2date[i].count
  }
};

function thisweekcore(index) {
  for (let item of gitcalendar.data[index]) {
    gitcalendar.thisweekdatacore += item.count
  }
};

function addlastweek() {
  for (let item of gitcalendar.lastweek) {
    gitcalendar.weekdatacore += item.count
  }
};

function addbeforeweek() {
  for (let i = gitcalendar.thisdayindex; i < gitcalendar.beforeweek.length; i++) {
    gitcalendar.weekdatacore += gitcalendar.beforeweek[i].count
  }
};

function addweek(data) {
  if (gitcalendar.thisdayindex === 6) {
    gitcalendar.aweekago = gitcalendar.lastweek[0].date;
    addlastweek()
  } else {
    lastweek = data.contributions[51];
    gitcalendar.aweekago = lastweek[gitcalendar.thisdayindex + 1].date;
    addlastweek();
    addbeforeweek()
  }
}

fetch(githubapiurl)
  .then(data => data.json())
  .then(data => {
    gitcalendar.data = data.contributions;
    gitcalendar.total = data.total;
    gitcalendar.first2date = gitcalendar.data[48];
    gitcalendar.firstdate = gitcalendar.data[47];
    gitcalendar.firstweek = data.contributions[0];
    gitcalendar.lastweek = data.contributions[52];
    gitcalendar.beforeweek = data.contributions[51];
    gitcalendar.thisdayindex = gitcalendar.lastweek.length - 1;
    gitcalendar.thisday = gitcalendar.lastweek[gitcalendar.thisdayindex].date;
    gitcalendar.oneyearbeforeday = gitcalendar.firstweek[0].date;
    gitcalendar.monthindex = gitcalendar.thisday.substring(5, 7) * 1;
    gitcalendar.montharrbefore = gitcalendar.month.splice(gitcalendar.monthindex, 12 - gitcalendar.monthindex);
    gitcalendar.monthchange = gitcalendar.montharrbefore.concat(gitcalendar.month);
    addweek(data);
    addlastmonth();
    responsiveChart();
  })
  .catch(function(error) {
    console.log(error);
  });

//手机版更换为svg绘制
if (document.getElementById("gitcalendarcanvasbox").offsetWidth < 500) {
  gitcalendar.simplemode = false
}

//当改变窗口大小时重新绘制canvas
window.onresize = function() {
  if (gitcalendar.simplemode) responsiveChart()
}

//解决滚动滑轮时出现的标签显示
window.onscroll = function() {
  if (document.querySelector('.angle-wrapper')) {
    document.querySelector('.angle-wrapper').style.display = 'none'
  }
};</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://yourapi.example.com/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.7/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script type="text/javascript" src="/js/welcome.js"></script><script type="text/javascript" src="/js/fixbugpjax.js"></script><div class="aplayer no-destroy" data-id="7803928554" data-server="netease" data-type="playlist" data-listfolded="false" data-preload="metadata" data-theme="var(--lyx-theme)" data-fixed="true" data-autoplay="false" data-volume="0.1" style="z-index:514"> </div><script type="text/javascript" src="/js/noie.js"></script><script src="https://cdn.jsdelivr.net/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script type="text/javascript" data-pjax="" src="/js/rightmenu.js"></script><script type="text/javascript" src="/js/copy.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script type="text/javascript" src="/js/resizeTop.js"></script><script type="text/javascript" src="/js/languages.js"></script><script type="text/javascript" src="/js/browser.js"></script><script type="text/javascript" src="/js/smooth-scrolling.js"></script><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><script type="text/javascript" src="/js/sitetime.js"></script><script type="text/javascript" src="/js/seo.js"></script><script data-pjax="" type="text/javascript" src="/js/heimu.js"></script><script data-pjax="" src="/js/bbtalklunbo.js"></script><script data-pjax="" src="/js/dis.js"></script><script data-pjax="" src="/js/settings.js"></script><script src="/js/owo.js"></script><script src="/js/welcomeconsole.js"></script><script src="/js/hide.show.js"></script><script src="https://f.zhheo.com/JS-Heo/bb/showbb_in_index.js" data-pjax="" =""="" defer=""></script><script data-pjax="" src="/js/baiduhistory.js"></script><script src="/js/random.js"></script><script data-pjax="" src="/js/nav.js"></script><script data-pjax="" type="text/javascript" src="/js/dianzan.js"></script><script type="text/javascript" src="/js/latest.js"></script><script data-pjax="" defer="" src="/js/fixed_card_widget.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/node-snackbar@latest/src/js/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax","#fixedcard-dashboard"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/speaks/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async="" data-pjax="" src="https://cdn.dusays.com/bsz.js"></script><div id="fixedcard-dashboard"><button class="fixedcard-activebtn" type="button" title="我的信息" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-info&quot;,&quot;0&quot;)"><i class="fas fa-address-book"></i></button><button class="fixedcard-activebtn" type="button" title="公告" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-announcement&quot;,&quot;0&quot;)"><i class="fas fa-bullhorn"></i></button><button class="fixedcard-activebtn" type="button" title="天气" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-weather&quot;,&quot;0&quot;)"><i class="fas fa-cloud-sun"></i></button><button class="fixedcard-activebtn" type="button" title="最新文章" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-recent-post&quot;,&quot;0&quot;)"><i class="fas fa-history"></i></button><button class="fixedcard-activebtn" type="button" title="最新评论" onclick="FixedCardWidget(&quot;id&quot;,&quot;card-newest-comments&quot;,&quot;0&quot;)"><i class="fas fa-comment-dots"></i></button><button class="fixedcard-activebtn" type="button" title="文章日历" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-calendar&quot;,&quot;0&quot;)"><i class="fas fa-calendar"></i></button><div class="fixedcard-user-avatar fixedcard-activebtn" onclick="RemoveFixedCardWidget()"><img class="fixedcard-user-avatar-img" src="/img/a.webp" title="Leechee"></div></div></div><div class="barrageswiper swiper-container"><div class="comment-barrage js-pjax swiper-wrapper"></div><link rel="stylesheet" href="/css/commentBarrage.css"><script data-pjax="" src="/js/commentBarrage.js"></script></div></body></html>